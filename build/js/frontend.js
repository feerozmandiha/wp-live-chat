!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.frontend=t():e.frontend=t()}(self,()=>(function(e,t){"use strict";if(void 0!==t){if(void 0!==e.wpLiveChat){class s{constructor(e){if(!e)throw console.error("Frontend instance is required for ConversationFlowManager"),new Error("Frontend instance is required");this.frontend=e,this.currentStep="welcome",this.userData={},this.requiresInput=!0,this.inputType="general_message",this.inputPlaceholder="",this.inputHint="",this.historyLoadAttempted=!1,this.pusherEnabled=!0,this.retryCount=0,this.maxRetries=5,this.pollingInterval=null,this.isPolling=!1,this.pusherChannel=null,this.pusherAdminChannel=null,this.pusherPresenceChannel=null,this.adminOnline=!1,this.connectionHealth={lastCheck:null,status:"unknown",failures:0},console.log("âœ… ConversationFlowManager created"),this.init()}init(){console.log("Initializing conversation flow manager..."),this.bindEvents(),setTimeout(()=>{this.loadCurrentStep()},1e3)}bindEvents(){this.frontend.pusherChannel&&(this.frontend.pusherChannel.bind("system-message",e=>{e.step&&(this.currentStep=e.step,this.updateInputUI())}),this.frontend.pusherChannel.bind("admin-online",()=>{"waiting_for_admin"===this.currentStep&&(this.currentStep="admin_connected",this.showSystemMessage("ğŸ‘¨â€ğŸ’¼ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯. Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯."))}),this.frontend.pusherChannel.bind("admin-offline",()=>{"chat_active"!==this.currentStep&&"admin_connected"!==this.currentStep||(this.currentStep="waiting_for_admin",this.showSystemMessage("â³ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯. Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯."))}))}async loadCurrentStep(){try{const e=await t.ajax({url:this.frontend.ajaxurl,type:"POST",data:{action:"get_conversation_step",nonce:this.frontend.nonce,session_id:this.frontend.sessionId},timeout:5e3});e.success&&(this.currentStep=e.data.current_step,this.userData=e.data.user_data||{},this.requiresInput=e.data.requires_input,this.inputType=e.data.input_type||"general_message",this.inputPlaceholder=e.data.input_placeholder||"",this.inputHint=e.data.input_hint||"",e.data.message&&!this.requiresInput&&this.showSystemMessage(e.data.message),this.updateInputUI(),console.log("âœ… Conversation flow loaded:",{step:this.currentStep,requiresInput:this.requiresInput,inputType:this.inputType}))}catch(e){console.error("âŒ Error loading conversation step:",e),this.setupFallbackFlow()}}setupFallbackFlow(){this.currentStep="welcome",this.requiresInput=!0,this.inputType="general_message",this.inputPlaceholder=this.frontend.strings.typeMessage||"Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯...",this.updateInputUI()}updateInputUI(){const e=this.frontend.$textarea,s=t("#wlch-input-hint");e&&(e.attr("placeholder",this.inputPlaceholder||this.frontend.strings.typeMessage||"Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..."),this.inputHint&&this.requiresInput?0===s.length?t('<div class="input-hint" id="wlch-input-hint"></div>').text(this.inputHint).insertAfter(e):s.text(this.inputHint).show():s.length>0&&s.hide(),this.setupInputValidation())}setupInputValidation(){const e=this.frontend.$textarea;switch(e.off("input.validation"),this.inputType){case"phone":e.on("input.validation",()=>{const t=e.val().trim();t&&!/^09[0-9]{0,9}$/.test(t)?(e.addClass("input-error"),this.showInlineError("ÙØ±Ù…Øª Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª (09xxxxxxxxx)")):(e.removeClass("input-error"),this.hideInlineError())});break;case"name":e.on("input.validation",()=>{const t=e.val().trim();t.length>0&&t.length<2?(e.addClass("input-error"),this.showInlineError("Ù†Ø§Ù… Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 2 Ø­Ø±Ù Ø¨Ø§Ø´Ø¯")):t.length>100?(e.addClass("input-error"),this.showInlineError("Ù†Ø§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² 100 Ø­Ø±Ù Ø¨Ø§Ø´Ø¯")):(e.removeClass("input-error"),this.hideInlineError())});break;default:e.removeClass("input-error"),this.hideInlineError()}}showInlineError(e){let s=t("#wlch-input-error");0===s.length&&(s=t('<div class="input-error-message" id="wlch-input-error"></div>').insertAfter(this.frontend.$textarea)),s.text(e).show()}hideInlineError(){t("#wlch-input-error").hide()}async processUserInput(e){if(!e.trim())return this.frontend.showAlert("Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ†ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯","error",3e3),!1;if(console.log("ğŸ” processUserInput called:",{message:e.substring(0,50),currentStep:this.currentStep,inputType:this.inputType}),!this.validateInput(e))return!1;try{console.log("ğŸ“¤ Sending AJAX request to process_conversation_step...");const s=await t.ajax({url:this.frontend.ajaxurl,type:"POST",data:{action:"process_conversation_step",nonce:this.frontend.nonce,session_id:this.frontend.sessionId,input:e,step:this.currentStep},timeout:1e4,dataType:"json"});if(console.log("ğŸ“¥ AJAX response received:",s),s.success){const e=s.data;return console.log("âœ… Conversation step processed successfully:",e),this.currentStep=e.next_step,this.userData=e.user_data,this.requiresInput=e.requires_input,this.inputType=e.input_type,this.inputPlaceholder=e.input_placeholder,this.inputHint=e.input_hint,e.message&&this.showSystemMessage(e.message),this.updateInputUI(),this.frontend.$textarea.val(""),this.frontend.updateCounter(),"chat_active"!==this.currentStep&&"waiting_for_admin"!==this.currentStep||this.checkAdminStatus(),console.log("âœ… Conversation step processed:",{oldStep:this.currentStep,newStep:e.next_step,inputType:e.input_type}),!0}return console.error("âŒ AJAX error in response:",s.data),this.frontend.showAlert(s.data||"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´","error"),!1}catch(e){return console.error("âŒ Error in processUserInput:",e),console.error("âŒ Error status:",e.status),console.error("âŒ Error response:",e.responseText),this.frontend.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±","error"),!1}}validateInput(e){const t=e.trim();switch(this.inputType){case"phone":if(!/^09[0-9]{9}$/.test(t))return this.frontend.showAlert("Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 09123456789)","error",4e3),!1;break;case"name":if(t.length<2)return this.frontend.showAlert("Ù†Ø§Ù… Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 2 Ø­Ø±Ù Ø¨Ø§Ø´Ø¯","error",4e3),!1;if(t.length>100)return this.frontend.showAlert("Ù†Ø§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² 100 Ø­Ø±Ù Ø¨Ø§Ø´Ø¯","error",4e3),!1;if(/[<>{}[\]]/.test(t))return this.frontend.showAlert("Ù†Ø§Ù… Ø´Ø§Ù…Ù„ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø² Ø§Ø³Øª","error",4e3),!1}return!0}async checkAdminStatus(){try{const e=await t.ajax({url:this.frontend.ajaxurl,type:"POST",data:{action:"check_admin_status",nonce:this.frontend.nonce},timeout:5e3});e.success&&e.data.admin_online&&"waiting_for_admin"===this.currentStep&&(this.currentStep="admin_connected",this.showSystemMessage("ğŸ‘¨â€ğŸ’¼ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯. Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯."),await this.notifyAdminConnected())}catch(e){console.error("âŒ Error checking admin status:",e)}}async notifyAdminConnected(){try{await t.ajax({url:this.frontend.ajaxurl,type:"POST",data:{action:"notify_admin_connected",nonce:this.frontend.nonce,session_id:this.frontend.sessionId},timeout:5e3})}catch(e){console.error("âŒ Error notifying admin connected:",e)}}showSystemMessage(e){this.frontend.appendMessage({id:"sys_"+Date.now(),message:e,user_name:"Ø³ÛŒØ³ØªÙ…",timestamp:(new Date).toISOString(),type:"system"})}getCurrentStep(){return this.currentStep}getInputType(){return this.inputType}isPhoneStep(){return"phone"===this.inputType}isNameStep(){return"name"===this.inputType}isGeneralMessageStep(){return"general_message"===this.inputType}}class n{constructor(e={}){this.ajaxurl=e.ajaxurl||"/wp-admin/admin-ajax.php",this.nonce=e.nonce||"",this.pusherKey=e.pusherKey||"",this.pusherCluster=e.pusherCluster||"",this.sessionId=e.sessionId||"chat_"+this._uuid(),this.currentUser=e.userData||e.currentUser||{},this.strings=e.strings||{},this.conversationFlowData=e.conversationFlow||{},this.pusher=null,this.isHistoryLoading=!1,this.historyLoaded=!1,this.messageHistory=[],this.selectors={container:"#wp-live-chat-container",messages:".chat-messages",toggle:".chat-toggle",widget:".chat-widget",userForm:".user-info-form",phoneInput:"#wlch-phone",nameInput:"#wlch-name",saveInfoBtn:"#wlch-save-info",skipInfoBtn:"#wlch-skip-info",inputArea:".chat-input-area",textarea:"#wlch-textarea",counter:"#wlch-counter",sendBtn:"#wlch-send-btn",closeBtn:".chat-close",notificationBadge:".notification-badge",typingIndicator:".typing-indicator"},this.maxChars=500,this.connected=!1,this.unreadCount=0,this.isTyping=!1,this.lastMessageId=null,this.messageQueue=new Set,this.messageHistory=[],this.isSending=!1,this.conversationFlow=null,this.conversationFlowData=e.conversationFlow||{},this.init()}init(){this.cacheElements(),this.$container.addClass("position-bottom-left"),this.bindUI(),this.loadHistoryAndScroll(),this.showUserForms(),this.initPusher(),this.updateCounter(),this.setConnectedStatus("connecting"),this.initConversationFlow()}initConversationFlow(){if(console.log("Initializing conversation flow..."),void 0===s)return console.error("ConversationFlowManager is not defined!"),void this.loadConversationFlowDynamically();try{this.conversationFlow=new s(this),console.log("âœ… ConversationFlowManager initialized successfully",this.conversationFlow),this.loadCurrentConversationStep()}catch(e){console.error("âŒ Failed to initialize ConversationFlowManager:",e),this.setupFallbackConversation()}}loadConversationFlowDynamically(){console.log("Attempting to load conversation flow dynamically..."),setTimeout(()=>{void 0!==s?this.initConversationFlow():(console.warn("ConversationFlowManager still not available, using fallback"),this.setupFallbackConversation())},2e3)}async loadCurrentConversationStep(){if(this.conversationFlow)try{const e=await t.ajax({url:this.ajaxurl,type:"POST",data:{action:"get_conversation_step",nonce:this.nonce,session_id:this.sessionId},timeout:5e3,dataType:"json"});if(e.success){const t=e.data;this.conversationFlow&&(this.conversationFlow.currentStep=t.current_step,this.conversationFlow.userData=t.user_data||{},this.conversationFlow.requiresInput=t.requires_input,this.conversationFlow.inputType=t.input_type||"general_message",this.conversationFlow.inputPlaceholder=t.input_placeholder||"",this.conversationFlow.inputHint=t.input_hint||"",this.conversationFlow.updateInputUI()),t.message&&!this.hasDisplayedSystemMessage(t.message)&&this.appendMessage({id:"sys_"+Date.now(),message:t.message,user_name:"Ø³ÛŒØ³ØªÙ…",timestamp:(new Date).toISOString(),type:"system"}),console.log("âœ… Current conversation step loaded:",t)}}catch(e){console.error("âŒ Error loading conversation step:",e),this.conversationFlow&&(this.conversationFlow.currentStep="welcome",this.conversationFlow.updateInputUI())}else console.warn("Conversation flow not initialized, skipping step load")}hasDisplayedSystemMessage(e){const s=this.$messages.find(".system-message .message-content p");for(let n=0;n<s.length;n++)if(t(s[n]).text().includes(e.substring(0,50)))return!0;return!1}setupFallbackConversation(){console.log("Using fallback conversation flow"),this.$textarea&&this.$textarea.attr("placeholder",this.strings.typeMessage||"Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯...")}cacheElements(){this.$container=t(this.selectors.container),this.$messages=this.$container.find(this.selectors.messages),this.$toggle=this.$container.find(this.selectors.toggle),this.$widget=this.$container.find(this.selectors.widget),this.$userForm=this.$container.find(this.selectors.userForm),this.$phoneInput=this.$container.find(this.selectors.phoneInput),this.$nameInput=this.$container.find(this.selectors.nameInput),this.$saveInfoBtn=this.$container.find(this.selectors.saveInfoBtn),this.$skipInfoBtn=this.$container.find(this.selectors.skipInfoBtn),this.$inputArea=this.$container.find(this.selectors.inputArea),this.$textarea=this.$container.find(this.selectors.textarea),this.$counter=this.$container.find(this.selectors.counter),this.$sendBtn=this.$container.find(this.selectors.sendBtn),this.$closeBtn=this.$container.find(this.selectors.closeBtn),this.$notif=this.$container.find(this.selectors.notificationBadge),this.$typingIndicator=this.$container.find(this.selectors.typingIndicator)}openChat(){this.isOpening||(this.isOpening=!0,this.$container.removeClass("wp-live-chat-hidden"),this.unreadCount=0,this.updateNotificationBadge(0),this.historyLoaded||this.isHistoryLoading||this.historyLoadAttempted?setTimeout(()=>{this.scrollToBottom(!0,!0),this.$textarea.focus()},100):(this.historyLoadAttempted=!0,this.isHistoryLoading=!0,this.loadHistoryAndScroll()),this.sendChatOpenedEvent(),setTimeout(()=>{this.isOpening=!1},500))}loadHistoryAndScroll(){this.historyLoaded||t.ajax({url:this.ajaxurl,type:"POST",data:{action:"get_chat_history",nonce:this.nonce,session_id:this.sessionId,limit:50},timeout:15e3}).done(e=>{e.success&&(this.historyLoaded=!0,this.renderHistory(e.data))}).fail(e=>{console.error("Failed to load history:",e),this.loadFromLocalStorage()}).always(()=>{this.isHistoryLoading=!1})}closeChat(){this.$container.addClass("wp-live-chat-hidden"),this.sendChatClosedEvent()}sendChatOpenedEvent(){if(this.pusher&&this.connected)try{const e=this.pusher.channel(`private-chat-${this.sessionId}`);e&&e.trigger("client-chat-opened",{user_id:this.currentUser.id||0,user_name:this.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±",timestamp:(new Date).toISOString()})}catch(e){}}sendChatClosedEvent(){if(this.pusher&&this.connected)try{const e=this.pusher.channel(`private-chat-${this.sessionId}`);e&&e.trigger("client-chat-closed",{user_id:this.currentUser.id||0,timestamp:(new Date).toISOString()})}catch(e){}}initPusher(){if(!this.pusherKey||"undefined"==typeof Pusher)return this.setConnectedStatus("offline"),this.showAlert("Ø³Ø±ÙˆÛŒØ³ Ú†Øª Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª","error",5e3),void console.error("Pusher key or library not found");try{"undefined"!=typeof window&&"localhost"!==window.location.hostname&&(Pusher.logToConsole=!1),this.pusher=new Pusher(this.pusherKey,{cluster:this.pusherCluster||"mt1",forceTLS:!0,authEndpoint:this.ajaxurl,auth:{params:{action:"pusher_auth",nonce:this.nonce,session_id:this.sessionId,user_name:this.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±",timestamp:Date.now()},headers:{"X-WP-Nonce":this.nonce}},enabledTransports:["ws","wss"],disabledTransports:["xhr_streaming","xhr_polling"],activityTimeout:12e4,pongTimeout:3e4,disableStats:!0,wsHost:"ws-"+(this.pusherCluster||"mt1")+".pusher.com",wssPort:443,wsPort:80}),this.pusher.connection.bind("state_change",e=>{switch(console.log("Pusher connection state changed:",e.previous,"->",e.current),e.current){case"connected":this.setConnectedStatus("online"),this.retryCount=0,this.connected=!0,this.showAlert("Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯","success",3e3),this.sendConnectionEvent("connected");break;case"connecting":this.setConnectedStatus("connecting"),this.connected=!1,console.log("Connecting to Pusher...");break;case"disconnected":this.setConnectedStatus("offline"),this.connected=!1,console.log("Disconnected from Pusher"),this.attemptReconnect();break;case"failed":this.setConnectedStatus("offline"),this.connected=!1,this.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³ Ú†Øª","error",5e3),console.error("Pusher connection failed"),this.attemptReconnect();break;case"unavailable":this.setConnectedStatus("offline"),this.connected=!1,console.warn("Pusher service unavailable"),this.initPollingFallback()}}),this.pusher.connection.bind("error",e=>{console.error("Pusher connection error:",e),("WebSocketError"===e.type||e.error)&&this.attemptReconnect()});const e=`private-chat-${this.sessionId}`,t=this.pusher.subscribe(e);t.bind("pusher:subscription_succeeded",()=>{console.log(`Successfully subscribed to channel: ${e}`),this.sendSubscriptionEvent("succeeded",e)}),t.bind("pusher:subscription_error",t=>{console.error(`Subscription error for channel ${e}:`,t),setTimeout(()=>{this.pusher&&"connected"===this.pusher.connection.state&&(console.log(`Retrying subscription to ${e}`),this.pusher.subscribe(e))},5e3)}),t.bind("new-message",e=>{console.log("New message received via Pusher:",e),this.onIncomingMessage(e)}),t.bind("admin-typing",()=>{console.log("Admin typing indicator received"),this.showTypingIndicator()}),t.bind("admin-stopped-typing",()=>{console.log("Admin stopped typing indicator received"),this.hideTypingIndicator()}),t.bind("message-read",e=>{console.log("Message read by admin:",e),this.markMessageAsRead(e.message_id)});const s=this.pusher.subscribe("admin-notifications");s.bind("admin-connected",e=>{console.log("Admin connected notification:",e),this.showAlert("Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯","info",3e3),this.adminOnline=!0,this.updateAdminStatus(!0)}),s.bind("admin-disconnected",e=>{console.log("Admin disconnected notification:",e),this.showAlert("Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯","warning",3e3),this.adminOnline=!1,this.updateAdminStatus(!1)}),s.bind("user-info-completed",e=>{console.log("User info completed:",e)});const n=this.pusher.subscribe("presence-chat");n.bind("pusher:member_added",e=>{console.log("Member added to chat:",e)}),n.bind("pusher:member_removed",e=>{console.log("Member removed from chat:",e)}),setInterval(()=>{this.pusher&&"connected"===this.pusher.connection.state&&this.sendPing()},45e3),this.pusherChannel=t,this.pusherAdminChannel=s,this.pusherPresenceChannel=n,console.log("Pusher initialized successfully")}catch(e){console.error("Error initializing Pusher:",e),this.setConnectedStatus("offline"),this.connected=!1;let t="Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³ Ú†Øª";e.message&&e.message.includes("app key")?t="ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØªØµØ§Ù„ Ú†Øª Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª":e.message&&e.message.includes("network")&&(t="Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú†Øª"),this.showAlert(t,"error",5e3),setTimeout(()=>this.attemptReconnect(),1e4)}}attemptReconnect(){if(this.retryCount>=this.maxRetries)return void this.initPollingFallback();this.retryCount++;const e=Math.min(1e3*Math.pow(2,this.retryCount),3e4);setTimeout(()=>{!this.connected&&this.pusherKey&&(this.pusher&&this.pusher.disconnect(),this.initPusher())},e)}initPollingFallback(){console.log("Initializing polling fallback"),this.pusherEnabled=!1,this.setConnectedStatus("offline"),this.pollingInterval=setInterval(()=>{!this.pusherEnabled&&this.sessionId&&this.pollForNewMessages()},1e4),this.showAlert("Ø³ÛŒØ³ØªÙ… Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø§ ØªØ§Ø®ÛŒØ± Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.","warning",5e3)}pollForNewMessages(){this.isPolling||(this.isPolling=!0,t.ajax({url:this.ajaxurl,type:"POST",data:{action:"poll_messages",nonce:this.nonce,session_id:this.sessionId,last_message_id:this.lastMessageId},timeout:8e3,dataType:"json"}).done(e=>{e.success&&e.data&&e.data.messages&&(e.data.messages.forEach(e=>{this.onIncomingMessage(e)}),e.data.messages.length>0&&(this.lastMessageId=e.data.messages[e.data.messages.length-1].id))}).fail(e=>{console.error("Polling error:",e)}).always(()=>{this.isPolling=!1}))}sendConnectionEvent(e){t.ajax({url:this.ajaxurl,type:"POST",data:{action:"update_connection_status",nonce:this.nonce,session_id:this.sessionId,status:e,timestamp:Date.now()},timeout:5e3}).fail(e=>{console.warn("Failed to send connection event:",e)})}sendSubscriptionEvent(e,s){t.ajax({url:this.ajaxurl,type:"POST",data:{action:"log_subscription",nonce:this.nonce,session_id:this.sessionId,channel:s,status:e,timestamp:Date.now()},timeout:5e3}).fail(e=>{console.warn("Failed to send subscription event:",e)})}sendPing(){if(this.pusher&&this.pusherChannel)try{this.pusherChannel.trigger("client-ping",{session_id:this.sessionId,timestamp:Date.now()})}catch(e){console.warn("Error sending ping:",e)}}cleanupPusher(){if(console.log("Cleaning up Pusher resources"),this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.pusher){try{this.pusherChannel&&this.pusher.unsubscribe(this.pusherChannel.name),this.pusherAdminChannel&&this.pusher.unsubscribe(this.pusherAdminChannel.name),this.pusherPresenceChannel&&this.pusher.unsubscribe(this.pusherPresenceChannel.name),this.pusher.disconnect()}catch(e){console.warn("Error during Pusher cleanup:",e)}this.pusher=null}this.connected=!1,this.pusherEnabled=!1,this.retryCount=0}checkConnectionHealth(){if(!this.pusher||!this.pusher.connection)return{status:"disconnected",details:"No Pusher instance"};const e=this.pusher.connection.state,t=this.pusher.connection.lastActivity,s=Date.now(),n=t?s-t:1/0;return{status:e,connected:"connected"===e,inactiveFor:n>6e4?Math.floor(n/1e3)+" seconds":"active",channels:this.pusher.allChannels().map(e=>e.name),retryCount:this.retryCount,pollingActive:!!this.pollingInterval,pusherEnabled:this.pusherEnabled}}onIncomingMessage(e){if(console.log("Incoming message from Pusher:",e),!e||!e.message&&!e.message_content&&""===!e.message)return void console.error("Invalid payload:",e);if("system"===e.type&&(!e.message||""===e.message.trim()))return void console.log("Empty system message ignored");const t=(e.message||e.message_content||"").trim();if(!t)return void console.error("Empty message:",e);const s=e.id||this.generateMessageId(t,e.timestamp);if(this.messageQueue.has(s))return void console.log("Duplicate message ignored (by ID):",s);if(this.isDuplicateMessage(t,e.timestamp))return void console.log("Duplicate message ignored (by content):",t.substring(0,50));const n=this.findOptimisticIdForMessage(t);if(n){console.log("Replacing optimistic message:",n,"with real message:",s);const t=this.$messages.find(`[data-message-id="${n}"]`);t.length?(t.removeClass("sending").addClass("sent"),t.find(".sending-status").text("âœ… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯"),setTimeout(()=>{t.fadeOut(300,()=>{t.remove(),this.messageQueue.delete(n),this.addMessageToChat({...e,id:s})})},1e3)):this.addMessageToChat({...e,id:s})}else this.addMessageToChat({...e,id:s})}generateMessageId(e,t){return`msg_${t?new Date(t).getTime():Date.now()}_${this.hashCode(e)}`}hashCode(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t&=t;return Math.abs(t).toString(16).substring(0,8)}isDuplicateMessage(e,s){const n=e.trim();if(!n)return!1;const i=s?new Date(s).getTime():Date.now();for(const e of this.messageHistory)if(e.text===n){const t=new Date(e.timestamp).getTime();if(Math.abs(i-t)<5e3)return!0}const o=this.$messages.find('.message:not([data-message-id^="temp_"])');for(let e=0;e<o.length;e++){const s=t(o[e]);if(s.find(".message-content p").text().trim()===n){const e=s.data("timestamp");if(!e)return!0;{const t=new Date(e).getTime();if(Math.abs(i-t)<5e3)return!0}}}return!1}addMessageToChat(e){e.id&&this.messageQueue.add(e.id),this.$messages.find(".welcome-message").length&&this.$messages.find(".welcome-message").remove(),this.hideTypingIndicator();const t=this._renderMessage(e);return this.messageHistory.push({id:e.id,text:e.message||e.message_content,timestamp:e.timestamp||(new Date).toISOString()}),this.messageHistory.length>50&&this.messageHistory.shift(),this.scrollToBottom(),this.$container.hasClass("wp-live-chat-hidden")&&"admin"===e.type&&(this.unreadCount++,this.updateNotificationBadge(this.unreadCount),"Notification"in window&&"granted"===Notification.permission&&new Notification("Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù†",{body:e.message||e.message_content,icon:"/wp-content/plugins/wp-live-chat/assets/images/icon.png"})),t}findOptimisticIdForMessage(e){const s=e.trim();let n=null;return this.$messages.find('.message[data-message-id^="temp_"]').each(function(){const e=t(this);if(e.find(".message-content p").text().replace("â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...","").replace("âœ… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯","").replace("âœ… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Ø³Ø±ÙˆØ±...)","").trim()===s)return n=e.data("message-id"),!1}),n}appendMessage(e){return!(e.id&&this.messageQueue.has(e.id)||(e.id&&this.messageQueue.add(e.id),this.$messages.find(".welcome-message").length&&this.$messages.find(".welcome-message").remove(),this.hideTypingIndicator(),this._renderMessage(e),this.scrollToBottom(),0))}_renderMessage(e){if(!this.$messages)return null;const s={id:"",message:"",user_name:"Ú©Ø§Ø±Ø¨Ø±",timestamp:(new Date).toISOString(),type:"user",status:"sent",...e},n=this._formatTime(s.timestamp);let i="user-message",o=s.user_name,r="",a="";switch(s.type){case"admin":i="admin-message",o="ğŸ‘¨â€ğŸ’¼ Ù¾Ø´ØªÛŒØ¨Ø§Ù†",a="slide-in-left";break;case"system":i="system-message",o="âš™ï¸ Ø³ÛŒØ³ØªÙ…",a="slide-in-left";break;case"user":o="ğŸ‘¤ "+o,a="slide-in-right"}switch(s.status){case"sending":r='<span class="message-status sending">â³</span>',i+=" sending";break;case"sent":r='<span class="message-status sent">âœ“</span>',i+=" sent";break;case"delivered":r='<span class="message-status delivered">âœ“âœ“</span>';break;case"read":r='<span class="message-status read">ğŸ‘ï¸</span>';break;case"error":r='<span class="message-status error">âŒ</span>',i+=" error"}let c=this._escapeHtml(s.message||s.message_content||"");c=this._addEmojis(c),c=this._autoLink(c);const h=t(`\n        <div class="message ${i} ${a}" data-message-id="${this._escapeAttr(s.id)}" data-timestamp="${this._escapeAttr(s.timestamp)}">\n        <div class="message-header">\n            <div class="message-sender">${o}</div>\n            <div class="message-time">${n} ${r}</div>\n        </div>\n        <div class="message-content">\n            <p>${c}</p>\n        </div>\n        </div>\n    `);return h.hide().appendTo(this.$messages).fadeIn(300),setTimeout(()=>{h.removeClass(a)},300),h}_autoLink(e){return e.replace(/(https?:\/\/[^\s]+)/g,function(e){return'<a href="'+e+'" target="_blank" rel="noopener noreferrer" style="color: #007cba; text-decoration: underline;">'+e+"</a>"})}sendMessage(e){if(!e||!e.trim())return;if(this.isSending)return void this.showAlert("Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...","info",2e3);const t=e.trim(),s="temp_"+Date.now()+"_"+this.hashCode(t);this.conversationFlow&&this.conversationFlow.requiresInput?this.processMessageWithFlow(t,s):this.processMessageDirectly(t,s)}processMessageDirectly(e,t){this.isSending=!0,this.$sendBtn.prop("disabled",!0).html('<span class="send-icon">â³</span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...');const s={id:t,message:e,user_name:this.currentUser.name||this.currentUser.display_name||"Ø´Ù…Ø§",timestamp:(new Date).toISOString(),type:"user",status:"sending"},n=this._renderMessage(s);this.messageQueue.add(t),this.$textarea.val(""),this.updateCounter(),this.scrollToBottom(),this.sendToServer(e,t,n)}sendToServer(e,s,n){const i=this;t.ajax({url:this.ajaxurl,type:"POST",data:{action:"send_chat_message",nonce:this.nonce,session_id:this.sessionId,message:e,step:this.conversationFlow?this.conversationFlow.getCurrentStep():"general_message",temp_id:s},dataType:"json",timeout:1e4}).done(function(e){e&&e.success?(i.showAlert("Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯","success",3e3),n&&(n.removeClass("sending").addClass("sent"),n.find(".message-status").text("âœ“").removeClass("sending").addClass("sent"),n.find(".sending-status").remove()),e.data.flow_result&&(i.conversationFlow.currentStep=e.data.flow_result.next_step,i.conversationFlow.updateInputPlaceholder())):i.handleSendError(n,s,e?e.data:"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…")}).fail(function(e,t,o){i.handleSendError(n,s,"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±"),console.error("Send message failed:",t,o)}).always(function(){i.isSending=!1,i.$sendBtn.prop("disabled",!1).html('<span class="send-icon">âœ‰ï¸</span> Ø§Ø±Ø³Ø§Ù„')})}async processMessageWithFlow(e,s){if(console.log("ğŸ”„ processMessageWithFlow called:",{text:e.substring(0,50),step:this.conversationFlow?this.conversationFlow.getCurrentStep():"unknown",messageId:s}),!this.conversationFlow)return console.error("âŒ Conversation flow not initialized"),void this.showAlert("Ø³ÛŒØ³ØªÙ… Ú†Øª Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª","error",3e3);this.isSending=!0,this.$sendBtn.prop("disabled",!0).html('<span class="send-icon">â³</span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...');const n={id:s,message:e,user_name:this.currentUser.name||this.currentUser.display_name||"Ø´Ù…Ø§",timestamp:(new Date).toISOString(),type:"user",status:"sending"},i=this._renderMessage(n);this.messageQueue.add(s),this.$textarea.val(""),this.updateCounter(),this.scrollToBottom();try{console.log("ğŸ“¤ Sending to process_conversation_step...");const n=await t.ajax({url:this.ajaxurl,type:"POST",data:{action:"process_conversation_step",nonce:this.nonce,session_id:this.sessionId,input:e,step:this.conversationFlow.getCurrentStep()},dataType:"json",timeout:3e4});if(console.log("ğŸ“¥ Response received:",n),n&&n.success){const e=n.data;console.log("âœ… Flow processed successfully:",{next_step:e.next_step,requires_input:e.requires_input,input_type:e.input_type}),i&&(i.removeClass("sending").addClass("sent"),i.find(".message-status").text("âœ“").removeClass("sending").addClass("sent")),this.conversationFlow&&(this.conversationFlow.currentStep=e.next_step||e.state.current_step,this.conversationFlow.userData=e.user_data||e.state.user_data||{},this.conversationFlow.requiresInput=e.requires_input||e.state.requires_input,this.conversationFlow.inputType=e.input_type||e.state.input_type,this.conversationFlow.inputPlaceholder=e.input_placeholder||e.state.input_placeholder,this.conversationFlow.inputHint=e.input_hint||e.state.input_hint,console.log("ğŸ”„ Conversation flow updated in frontend:",{step:this.conversationFlow.currentStep,inputType:this.conversationFlow.inputType,requiresInput:this.conversationFlow.requiresInput}),this.conversationFlow.updateInputUI(),e.message&&""!==e.message.trim()&&(console.log("ğŸ“¢ System message to show:",e.message),this.shouldShowSystemMessage(e.message)&&(this.appendMessage({id:"sys_"+Date.now(),message:e.message,user_name:"Ø³ÛŒØ³ØªÙ…",timestamp:(new Date).toISOString(),type:"system"}),this.markSystemMessageShown(e.message))),this.conversationFlow.requiresInput||"chat_active"!==this.conversationFlow.currentStep||setTimeout(()=>{this.$textarea.focus()},100)),this.showAlert("Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯","success",2e3),console.log("ğŸ¯ Final flow state:",{step:this.conversationFlow?this.conversationFlow.getCurrentStep():"unknown",canSendNext:!!this.conversationFlow&&this.conversationFlow.requiresInput,inputType:this.conversationFlow?this.conversationFlow.getInputType():"unknown"})}else{console.error("âŒ Server error:",n);const e=n&&n.data&&n.data.message?n.data.message:"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…";this.handleSendError(i,s,e)}}catch(e){console.error("âŒ AJAX error:",e);let t="Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±";"timeout"===e.statusText&&(t="Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."),this.handleSendError(i,s,t)}finally{this.isSending=!1,this.$sendBtn.prop("disabled",!1).html('<span class="send-icon">âœ‰ï¸</span> Ø§Ø±Ø³Ø§Ù„'),this.conversationFlow&&this.conversationFlow.requiresInput&&setTimeout(()=>{this.$textarea.focus()},100)}}markSystemMessageShown(e){const t="shown_system_msg_"+this.hashCode(e);sessionStorage.setItem(t,"true")}shouldShowSystemMessage(e){const t="shown_system_msg_"+this.hashCode(e);return!sessionStorage.getItem(t)}handleFlowTimeout(e,t,s){console.log("â° Flow timeout handler called"),e&&(e.addClass("message-error"),e.find(".message-content p").append('<small style="display:block; color:#ffb900; margin-top:5px; font-style:italic;">âš ï¸ Ø²Ù…Ø§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø·ÙˆÙ„ Ú©Ø´ÛŒØ¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯</small>')),this.messageQueue.delete(t),this.showAlert("Ø²Ù…Ø§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø·ÙˆÙ„ Ú©Ø´ÛŒØ¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯","warning",5e3),this.isSending=!1,this.$sendBtn.prop("disabled",!1).html('<span class="send-icon">âœ‰ï¸</span> Ø§Ø±Ø³Ø§Ù„'),this.$textarea.focus()}updateInputPlaceholder(){const e=this.frontend.$textarea;if(!e)return;let t="";switch(this.inputType){case"phone":t=this.frontend.strings.phonePlaceholder||"Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„...";break;case"name":t=this.frontend.strings.namePlaceholder||"Ù†Ø§Ù… ÛŒØ§ Ø´Ø±Ú©Øª...";break;default:t=this.frontend.strings.typeMessage||"Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..."}e.attr("placeholder",t),this.updateInputUI()}handleSendError(e,t,s){e&&(e.addClass("message-error"),e.find(".message-content p").append('<small style="display:block; color:#dc3232; margin-top:5px; font-style:italic;">âš ï¸ '+s+"</small>")),this.messageQueue.delete(t),this.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: "+s,"error",5e3),this.$textarea.focus()}sendTypingEvent(e){if(this.pusher&&this.connected)try{const t=this.pusher.channel("private-chat-"+this.sessionId);t&&("typing"===e?t.trigger("client-user-typing",{user_id:this.currentUser.id||0,user_name:this.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±",timestamp:Date.now()}):"stopped"===e&&t.trigger("client-user-stopped-typing",{user_id:this.currentUser.id||0,timestamp:Date.now()}))}catch(t){console.log("Typing event error:",t),this.sendTypingViaAjax(e)}}sendTypingViaAjax(e){t.ajax({url:this.ajaxurl,type:"POST",data:{action:"wp_live_chat_typing",nonce:this.nonce,session_id:this.sessionId,status:e,user_name:this.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±"},timeout:3e3}).fail(function(){})}showTypingIndicator(){this.$typingIndicator&&(this.$typingIndicator.stop(!0,!0).fadeIn(300),this.scrollToBottom())}hideTypingIndicator(){this.$typingIndicator&&this.$typingIndicator.stop(!0,!0).fadeOut(300)}showUserForms(){if(this.currentUser&&(this.currentUser.phone||this.currentUser.name))return this.showInputArea(!0),this.showUserInfoForm(!1),void this.showAlert("Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ "+(this.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±"),"info",3e3);this.showInputArea(!1),this.showUserInfoForm(!0)}showInputArea(e){this.$inputArea&&(e?(this.$inputArea.slideDown(300),setTimeout(()=>this.$textarea.focus(),350)):this.$inputArea.slideUp(300))}showUserInfoForm(e){this.$userForm&&(e?(this.$userForm.slideDown(400),setTimeout(()=>this.$phoneInput.focus(),450)):this.$userForm.slideUp(300))}loadHistory(){const e=this;this.$messages.html(`\n        <div class="welcome-message">\n          <p>${this._escapeHtml(this.strings.welcome||"Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.")}</p>\n        </div>\n        <div class="loading-history" style="text-align:center; padding:20px; color:#666;">\n          <div class="spinner"></div>\n          <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡...</p>\n        </div>\n      `),t.ajax({url:this.ajaxurl,type:"POST",data:{action:"get_chat_history",nonce:this.nonce,session_id:this.sessionId},dataType:"json",timeout:1e4}).done(function(t){e.$messages.find(".loading-history").remove(),t&&t.success&&Array.isArray(t.data)?0===t.data.length||(e.$messages.find(".welcome-message").remove(),t.data.forEach(function(t){e.messageQueue.has(t.id)||e.appendMessage({id:t.id,message:t.message_content,user_name:t.user_name,timestamp:t.created_at,type:t.message_type})})):e.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡","error")}).fail(function(){e.$messages.find(".loading-history").remove(),e.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡","error")})}bindUI(){const e=this;let s;t(document).on("click",this.selectors.toggle,function(){e.$container.hasClass("wp-live-chat-hidden")?(e.$container.removeClass("wp-live-chat-hidden"),e.unreadCount=0,e.updateNotificationBadge(0),setTimeout(()=>{0===e.messageHistory.length?e.loadHistoryAndScroll():e.scrollToBottom(!0),e.$textarea.focus()},100)):e.$container.addClass("wp-live-chat-hidden")}),t(document).on("click",this.selectors.closeBtn,function(){e.$container.addClass("wp-live-chat-hidden")}),t(document).on("click",this.selectors.container+" .chat-widget",function(s){t(s.target).closest(".chat-messages, .chat-header").length||setTimeout(()=>e.$textarea.focus(),50)}),t(document).on("click",this.selectors.saveInfoBtn,function(){const s=e.$phoneInput.val().trim(),n=e.$nameInput.val().trim();s||n?(t(this).prop("disabled",!0).html('<span class="btn-icon">â³</span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...'),t.ajax({url:e.ajaxurl,type:"POST",data:{action:"save_user_info",nonce:e.nonce,session_id:e.sessionId,phone:s,name:n,company:""},dataType:"json",timeout:1e4}).done(function(i){i&&i.success?(e.currentUser.phone=s||e.currentUser.phone,e.currentUser.name=n||e.currentUser.name,e.showUserForms(),e.showInputArea(!0),e.showAlert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯","success",3e3),t.post(e.ajaxurl,{action:"send_welcome_message",nonce:e.nonce,session_id:e.sessionId,user_name:e.currentUser.name})):e.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª","error",4e3)}).fail(function(){e.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±","error",4e3)}).always(function(){t(this).prop("disabled",!1).html('<span class="btn-icon">âœ“</span> Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª')})):e.showAlert("Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯","error",3e3)}),t(document).on("click",this.selectors.skipInfoBtn,function(){e.currentUser=e.currentUser||{},e.currentUser.name=e.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±_"+Math.floor(9e3*Math.random()+1e3),e.showUserForms(),e.showInputArea(!0),e.showAlert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¨Ø¹Ø¯Ø§Ù‹ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯","info",3e3)}),t(document).on("input",this.selectors.textarea,function(){e.updateCounter();const s=t(this).val().trim();!e.isTyping&&s.length>0?(e.isTyping=!0,e.sendTypingEvent("typing")):e.isTyping&&0===s.length&&(e.isTyping=!1,e.sendTypingEvent("stopped"))}),t(document).on("keyup",this.selectors.textarea,function(){clearTimeout(s),s=setTimeout(function(){e.isTyping&&(e.isTyping=!1,e.sendTypingEvent("stopped"))},1e3)}),t(document).on("click",this.selectors.sendBtn,function(){const t=e.$textarea.val().trim();e.sendMessage(t)}),t(document).on("keydown",this.selectors.textarea,function(s){if("Enter"===s.key&&!s.shiftKey){s.preventDefault();const n=t(this).val().trim();n&&!e.$sendBtn.prop("disabled")&&e.sendMessage(n)}}),t(document).on("animationend",this.selectors.inputArea,function(){t(this).is(":visible")&&e.$textarea.focus()}),t(document).on("input",this.selectors.textarea,function(){if(e.updateCounter(),e.conversationFlow&&e.conversationFlow.isPhoneStep()){const e=t(this).val().trim();e&&!/^09[0-9]{0,9}$/.test(e)?t(this).addClass("input-error"):t(this).removeClass("input-error")}const s=t(this).val().trim();!e.isTyping&&s.length>0?(e.isTyping=!0,e.sendTypingEvent("typing")):e.isTyping&&0===s.length&&(e.isTyping=!1,e.sendTypingEvent("stopped"))})}showAlert(e,s="info",n=5e3){t(".alert-message").remove();const i={success:"âœ…",error:"âŒ",info:"â„¹ï¸",warning:"âš ï¸"},o=t(`\n        <div class="alert-message alert-${s}">\n          <span class="alert-icon">${i[s]||i.info}</span>\n          <div class="alert-content">\n            <div class="alert-title">${"success"===s?"Ù…ÙˆÙÙ‚ÛŒØª":"error"===s?"Ø®Ø·Ø§":"ØªÙˆØ¬Ù‡"}</div>\n            <div class="alert-text">${this._escapeHtml(e)}</div>\n          </div>\n          <button class="alert-close">&times;</button>\n        </div>\n      `);return t("body").append(o),o.find(".alert-close").on("click",function(){o.fadeOut(300,function(){t(this).remove()})}),n>0&&setTimeout(function(){o.is(":visible")&&o.fadeOut(300,function(){t(this).remove()})},n),o}setConnectedStatus(e){this.connected="online"===e;const t=this.$container.find(".status-dot"),s=this.$container.find(".status-text");t.removeClass("connecting online offline").addClass(e),s.text({online:"Ø¢Ù†Ù„Ø§ÛŒÙ†",offline:"Ø¢ÙÙ„Ø§ÛŒÙ†",connecting:"Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„..."}[e]||e)}updateCounter(){if(!this.$textarea||!this.$counter||!this.$sendBtn)return;const e=(this.$textarea.val()||"").length,t=this.maxChars-e;this.$counter.text(`${e}/${this.maxChars}`),0===e?(this.$sendBtn.prop("disabled",!0),this.$counter.removeClass("exceeded warning")):e>this.maxChars?(this.$sendBtn.prop("disabled",!0),this.$counter.addClass("exceeded")):(this.$sendBtn.prop("disabled",!1),this.$counter.removeClass("exceeded"),t<=50?this.$counter.addClass("warning"):this.$counter.removeClass("warning"))}updateNotificationBadge(e){this.unreadCount=e,this.$notif&&(!e||e<=0?this.$notif.hide():this.$notif.text(e>9?"9+":e).show())}scrollToBottom(e=!1,t=!1){if(!this.$messages||!this.$messages.length)return;const s=this.$messages[0].scrollHeight,n=this.$messages.height();!t&&s-(this.$messages.scrollTop()+n)>200||(e?this.$messages.scrollTop(s):this.$messages.stop().animate({scrollTop:s},300))}_formatTime(e){if(!e)return"";try{let t;if(t="string"==typeof e?e.includes("T")?new Date(e):new Date(e.replace(" ","T")):new Date(e),!isNaN(t.getTime()))return t.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit",hour12:!1})}catch(e){}return e}_addEmojis(e){const t={":)":"ğŸ˜Š",":-)":"ğŸ˜Š",":(":"ğŸ˜",":-(":"ğŸ˜",":D":"ğŸ˜ƒ",":-D":"ğŸ˜ƒ",";)":"ğŸ˜‰",";-)":"ğŸ˜‰",":P":"ğŸ˜›",":-P":"ğŸ˜›",":O":"ğŸ˜®",":-O":"ğŸ˜®",":*":"ğŸ˜˜",":-*":"ğŸ˜˜","<3":"â¤ï¸",":heart:":"â¤ï¸",":like:":"ğŸ‘",":thumbsup:":"ğŸ‘",":thanks:":"ğŸ™",":ok:":"ğŸ‘Œ","?:":"â“"};let s=e;for(const[e,n]of Object.entries(t))s=s.replace(new RegExp(this._escapeRegex(e),"g"),n);return s}_escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}_escapeHtml(e){return t("<div/>").text(e||"").html()}_escapeAttr(e){return String(e||"").replace(/["'<>]/g,"")}_uuid(){return"xxxxxxxx".replace(/[x]/g,function(){return(16*Math.random()|0).toString(16)})}}console.log("WP Live Chat Frontend script loaded"),console.log("Window.wpLiveChat:",window.wpLiveChat),console.log("ConversationFlowManager defined:",void 0!==s),void 0===s&&(console.warn("ConversationFlowManager is not defined, loading conversation-flow.js might have failed"),window.ConversationFlowManager=class{constructor(e){console.log("Using fallback ConversationFlowManager"),this.frontend=e,this.currentStep="welcome",this.requiresInput=!0,this.inputType="general_message"}processUserInput(e){return Promise.resolve(!0)}updateInputUI(){this.frontend.$textarea&&this.frontend.$textarea.attr("placeholder","Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯...")}}),t(function(){try{const s=new n(e.wpLiveChat||{});e._wpLiveChatFrontend=s,t("<style>").text("\n                  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ conversation flow */\n                  .input-hint {\n                      display: block;\n                      font-size: 11px;\n                      color: #666;\n                      margin-top: 5px;\n                      margin-bottom: 8px;\n                      padding: 4px 8px;\n                      background: #f8f9fa;\n                      border-radius: 4px;\n                      border-right: 3px solid #007cba;\n                      animation: fadeIn 0.3s ease;\n                  }\n                  \n                  .input-error-message {\n                      display: none;\n                      font-size: 11px;\n                      color: #dc3232;\n                      margin-top: 5px;\n                      margin-bottom: 8px;\n                      padding: 6px 10px;\n                      background: #fff5f5;\n                      border-radius: 4px;\n                      border: 1px solid #ffcccc;\n                      animation: shake 0.3s ease;\n                  }\n                  \n                  .input-error {\n                      border-color: #dc3232 !important;\n                      box-shadow: 0 0 0 1px rgba(220, 50, 50, 0.2) !important;\n                      animation: pulseError 0.5s ease;\n                  }\n                  \n                  @keyframes fadeIn {\n                      from { opacity: 0; transform: translateY(-5px); }\n                      to { opacity: 1; transform: translateY(0); }\n                  }\n                  \n                  @keyframes shake {\n                      0%, 100% { transform: translateX(0); }\n                      25% { transform: translateX(-5px); }\n                      75% { transform: translateX(5px); }\n                  }\n                  \n                  @keyframes pulseError {\n                      0%, 100% { border-color: #dc3232; }\n                      50% { border-color: #ff6b6b; }\n                  }\n                  \n                  /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø¨Ø±Ø§ÛŒ Ø§Ù†ÙˆØ§Ø¹ input */\n                  .phone-input-hint {\n                      border-right-color: #25D366;\n                  }\n                  \n                  .name-input-hint {\n                      border-right-color: #ffb900;\n                  }\n                  \n                  .general-input-hint {\n                      border-right-color: #007cba;\n                  }\n                  \n                  /* loading spinner */\n                  .loading-history .spinner {\n                      display: inline-block;\n                      width: 40px;\n                      height: 40px;\n                      border: 3px solid #f3f3f3;\n                      border-top: 3px solid #007cba;\n                      border-radius: 50%;\n                      animation: spin 1s linear infinite;\n                  }\n                  \n                  @keyframes spin {\n                      0% { transform: rotate(0deg); }\n                      100% { transform: rotate(360deg); }\n                  }\n                  \n                  .message-error {\n                      opacity: 0.7;\n                      border-color: #dc3232 !important;\n                  }\n              ").appendTo("head")}catch(e){console.error("WPLiveChatFrontend init error",e)}})}}else console&&console.error&&console.error("jQuery required by WPLiveChatFrontend")}(window,jQuery),{}));