!function(s,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["admin-chat"]=e():s["admin-chat"]=e()}(self,()=>(function(s){"use strict";class e{constructor(){this.config=window.wpLiveChatAdmin||{},this.ajaxurl=this.config.ajaxurl||"/wp-admin/admin-ajax.php",this.nonce=this.config.nonce||"",this.pusherKey=this.config.pusherKey||"",this.pusherCluster=this.config.pusherCluster||"mt1",this.pusher=null,this.channel=null,this.sessions=[],this.currentSession=null,this.isLoading=!1,this.retryCount=0,this.maxRetries=6,this.reconnectTimer=null,this.messageQueue=new Set,this.pingInterval=null,this.sessionsRefreshInterval=null,this.selectors={sessionsList:"#sessions-list",refreshBtn:"#refresh-sessions",messagesContainer:"#admin-chat-messages",sendButton:"#admin-send-button",messageInput:"#admin-message-input",sessionTitle:"#current-session-title",sessionStatus:"#session-status"},this.init()}init(){this.bindEvents(),this.initPusher(),this.loadSessions(),this.sessionsRefreshInterval=setInterval(()=>this.loadSessions(!1),3e4),s(document).ajaxError((s,e,t,i)=>{console.warn("Admin AJAX error",t.url,i)})}bindEvents(){const e=this;s(document).on("click",this.selectors.refreshBtn,function(){e.loadSessions(!0)}),s(document).on("click",this.selectors.sendButton,function(){e.sendMessage()}),s(document).on("keydown",this.selectors.messageInput,function(s){"Enter"!==s.key||s.shiftKey||(s.preventDefault(),e.sendMessage())})}initPusher(){if(this.pusherKey&&"undefined"!=typeof Pusher){if(this.pusher)try{this.cleanupPusher()}catch(s){console.warn(s)}try{this.pusher=new Pusher(this.pusherKey,{cluster:this.pusherCluster,forceTLS:!0,authEndpoint:this.ajaxurl,auth:{params:{action:"pusher_auth",nonce:this.nonce}},activityTimeout:12e4,pongTimeout:3e4,disableStats:!0});const s="admin-notifications";this.channel=this.pusher.subscribe(s),this.channel.bind("new-chat",s=>this.handleNewChatNotification(s)),this.channel.bind("admin-connected",s=>{this.showToast(this._t("admin_connected","کاربر پشتیبانی متصل شد"),"info")}),this.pusher.connection.bind("state_change",s=>{console.log("Pusher state (admin):",s.current),"connected"===s.current?this.retryCount=0:"disconnected"===s.current||"failed"===s.current?this.attemptReconnect():"unavailable"===s.current&&this.showToast(this._t("connection_unavailable","اتصال اعلان‌ها در دسترس نیست"),"warning")}),this.pusher.connection.bind("error",s=>{console.error("Pusher admin error",s),this.attemptReconnect()})}catch(s){console.error("Failed to initialize Pusher (admin):",s)}}else console.warn("Pusher unavailable for admin panel — polling fallback will be used if implemented on server")}cleanupPusher(){try{if(this.pusher){try{this.channel&&(this.pusher.unsubscribe(this.channel.name||"admin-notifications"),this.channel=null)}catch(s){console.warn(s)}try{this.pusher.disconnect()}catch(s){console.warn(s)}}}finally{this.pusher=null}}attemptReconnect(){if(!this.pusherKey)return;if(this.retryCount>=this.maxRetries)return void console.warn("Admin: max reconnect attempts reached");this.retryCount++;const s=Math.min(1e3*Math.pow(2,this.retryCount),3e4);clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout(()=>this.initPusher(),s)}async loadSessions(e=!0){if(this.isLoading)return;this.isLoading=!0;const t=s(this.selectors.refreshBtn);e&&t.length&&t.prop("disabled",!0).text(this._t("loading","در حال بارگذاری..."));try{const e=await s.ajax({url:this.ajaxurl,type:"POST",dataType:"json",timeout:1e4,data:{action:"wp_live_chat_get_sessions",nonce:this.nonce}});e&&e.success?(this.sessions=e.data||[],this.renderSessions()):(console.warn("loadSessions response error",e),this.showToast(this._t("load_sessions_error","خطا در بارگذاری جلسات"),"error"))}catch(s){console.error("loadSessions ajax error",s),this.showToast(this._t("load_sessions_error","خطا در بارگذاری جلسات"),"error")}finally{this.isLoading=!1,e&&t.length&&t.prop("disabled",!1).text(this._t("refresh","بروزرسانی"))}}renderSessions(){const e=s(this.selectors.sessionsList);0!==e.length&&(e.empty(),this.sessions&&0!==this.sessions.length?this.sessions.forEach(t=>{const i=t.unread_count&&t.unread_count>0,n=t.last_activity||t.updated_at||"",a=s(`\n                    <div class="session-item ${i?"has-unread":""}" data-session-id="${this.escapeHtml(t.session_id)}">\n                        <div class="session-left">\n                            <div class="session-user">${this.escapeHtml(t.user_name||t.user_email||"کاربر")}</div>\n                            <div class="session-meta">${this.escapeHtml(t.user_agent||"")}</div>\n                        </div>\n                        <div class="session-right">\n                            <div class="session-last">${this.escapeHtml(this.formatTime(n))}</div>\n                            ${i?`<span class="unread-badge">${t.unread_count}</span>`:""}\n                        </div>\n                    </div>\n                `);a.on("click",()=>this.selectSession(t)),e.append(a)}):e.html(`<div class="no-sessions">${this._t("no_sessions","هیچ گفتگویی وجود ندارد")}</div>`))}async selectSession(e){e&&e.session_id&&(s(".session-item").removeClass("active"),s(`.session-item[data-session-id="${this.escapeHtml(e.session_id)}"]`).addClass("active"),this.currentSession=e,s(this.selectors.sessionTitle).text(e.user_name||"کاربر"),s(this.selectors.sessionStatus).removeClass("status-online status-offline").addClass("active"===e.status?"status-online":"status-offline").text("active"===e.status?this._t("online","آنلاین"):this._t("offline","آفلاین")),e.unread_count&&e.unread_count>0&&await this.markSessionAsRead(e.session_id),await this.loadSessionMessages(e.session_id),this.subscribeToSession(e.session_id))}async loadSessionMessages(e){if(e)try{const t=await s.ajax({url:this.ajaxurl,type:"POST",dataType:"json",timeout:1e4,data:{action:"wp_live_chat_get_messages",nonce:this.nonce,session_id:e}});t&&t.success?this.renderMessages(t.data||[]):(console.warn("loadSessionMessages response error",t),this.showToast(this._t("load_messages_error","خطا در بارگذاری پیام‌ها"),"error"))}catch(s){console.error("loadSessionMessages ajax error",s),this.showToast(this._t("load_messages_error","خطا در بارگذاری پیام‌ها"),"error")}}renderMessages(e){const t=s(this.selectors.messagesContainer);0!==t.length&&(t.empty(),e&&0!==e.length?(e.forEach(s=>{const e="admin"===s.message_type||"admin"===s.from?"admin":"user",i=s.id||s.message_id||this.generateMessageId(s.message_content||s.message||"",s.created_at||s.timestamp);if(this.messageQueue.has(i))return;if(this.messageQueue.add(i),this.messageQueue.size>1e3){const s=this.messageQueue.values();this.messageQueue.delete(s.next().value)}const n=`\n                    <div class="message ${e}" data-message-id="${this.escapeHtml(i)}">\n                        <div class="message-header">\n                            <span class="sender">${"admin"===e?this._t("support","پشتیبانی"):this.escapeHtml(s.user_name||"کاربر")}</span>\n                            <span class="time">${this.escapeHtml(this.formatTime(s.created_at||s.timestamp||""))}</span>\n                        </div>\n                        <div class="message-body">${this.escapeHtml(s.message_content||s.message||"")}</div>\n                    </div>\n                `;t.append(n)}),t.stop().animate({scrollTop:t[0].scrollHeight},200)):t.html(`<div class="no-messages">${this._t("no_messages","هنوز پیامی رد و بدل نشده است")}</div>`))}async sendMessage(){if(!this.currentSession||!this.currentSession.session_id)return void this.showToast(this._t("select_session","لطفاً ابتدا یک گفتگو را انتخاب کنید"),"error");const e=s(this.selectors.messageInput),t=e.val()?e.val().trim():"";if(!t)return void this.showToast(this._t("empty_message","پیامی وارد نشده"),"error");const i=s(this.selectors.sendButton);i.prop("disabled",!0).text(this._t("sending","در حال ارسال..."));try{const i=await s.ajax({url:this.ajaxurl,type:"POST",dataType:"json",timeout:1e4,data:{action:"wp_live_chat_send_admin_message",nonce:this.nonce,session_id:this.currentSession.session_id,message:t}});i&&i.success?(e.val(""),this.addLocalMessage({message_content:t,message_type:"admin",created_at:(new Date).toISOString(),user_name:this._t("support","پشتیبانی"),id:i.data&&i.data.id?i.data.id:void 0}),this.loadSessions(!1)):(console.warn("sendMessage response error",i),this.showToast(this._t("send_failed","ارسال پیام با خطا مواجه شد"),"error"))}catch(s){console.error("sendMessage ajax error",s),this.showToast(this._t("send_failed","ارسال پیام با خطا مواجه شد"),"error")}finally{i.prop("disabled",!1).text(this._t("send","ارسال"))}}addLocalMessage(e){const t=s(this.selectors.messagesContainer);if(0===t.length)return;const i=e.id||this.generateMessageId(e.message_content||e.message||"",e.created_at||Date.now());if(this.messageQueue.has(i))return;this.messageQueue.add(i);const n=`\n                <div class="message admin" data-message-id="${this.escapeHtml(i)}">\n                    <div class="message-header">\n                        <span class="sender">${this.escapeHtml(e.user_name||this._t("support","پشتیبانی"))}</span>\n                        <span class="time">${this.escapeHtml(this.formatTime(e.created_at))}</span>\n                    </div>\n                    <div class="message-body">${this.escapeHtml(e.message_content||e.message||"")}</div>\n                </div>\n            `;t.append(n),t.stop().animate({scrollTop:t[0].scrollHeight},150)}async markSessionAsRead(e){if(e)try{const t=await s.ajax({url:this.ajaxurl,type:"POST",dataType:"json",data:{action:"wp_live_chat_mark_read",nonce:this.nonce,session_id:e},timeout:8e3});if(t&&t.success){s(`.session-item[data-session-id="${this.escapeHtml(e)}"]`).removeClass("has-unread").find(".unread-badge").remove();const t=this.sessions.find(s=>s.session_id===e);t&&(t.unread_count=0)}else console.warn("markSessionAsRead response error",t)}catch(s){console.warn("markSessionAsRead ajax error",s)}}subscribeToSession(s){if(this.pusher){if(this.sessionChannel){try{this.pusher.unsubscribe(this.sessionChannel.name)}catch(s){console.warn(s)}this.sessionChannel=null}try{const e=`private-chat-${s}`;this.sessionChannel=this.pusher.subscribe(e),this.sessionChannel.bind("new-message",e=>{this.currentSession&&this.currentSession.session_id===s?this.handleIncomingSessionMessage(e):this.loadSessions(!1)}),this.sessionChannel.bind("pusher:subscription_error",s=>{console.error("session subscription error",s)})}catch(s){console.warn("subscribeToSession failed",s)}}}handleIncomingSessionMessage(s){if(!s)return;const e=s.message||s.message_content||s.text||"";if(!e)return;const t=s.id||s.message_id||this.generateMessageId(e,s.created_at||s.timestamp||Date.now());if(this.messageQueue.has(t))return;this.messageQueue.add(t);const i={id:t,message_content:e,user_name:s.user_name||s.sender||this._t("user","کاربر"),message_type:s.type||"user",created_at:s.created_at||s.timestamp||(new Date).toISOString()};this.addLocalMessage(i),this.showToast(this._t("new_message","پیام جدید از کاربر"),"info"),this.loadSessions(!1)}handleNewChatNotification(s){this.loadSessions(!1),this.showToast(this._t("new_chat","گفتگوی جدید"),"info"),"Notification"in window&&"granted"===Notification.permission&&new Notification(this._t("new_chat","گفتگوی جدید"),{body:s&&s.user_name?s.user_name:"",icon:this.config.icon||""})}generateMessageId(s,e){const t=`${s}-${e?"number"==typeof e?e:Date.parse(e)||Date.now():Date.now()}`;let i=5381;for(let s=0;s<t.length;s++)i=(i<<5)+i+t.charCodeAt(s);return"wlm-"+(i>>>0).toString(36)}formatTime(s){if(!s)return"";try{const e=new Date(s);return isNaN(e.getTime())?s:e.toLocaleString("fa-IR",{hour:"2-digit",minute:"2-digit"})}catch(e){return s}}escapeHtml(s){return null==s?"":String(s).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}showToast(e,t="info",i=5e3){0===s("#wl-admin-toast-area").length&&s("body").append('<div id="wl-admin-toast-area" style="position:fixed;z-index:9999;right:20px;bottom:20px;"></div>');const n=s(`<div class="wl-admin-toast wl-admin-toast-${t}">${this.escapeHtml(e)}</div>`);s("#wl-admin-toast-area").append(n),n.hide().fadeIn(150),setTimeout(()=>n.fadeOut(200,function(){s(this).remove()}),i)}_t(s,e){return this.config.strings&&void 0!==this.config.strings[s]?this.config.strings[s]:e||s}}s(document).ready(function(){if(window.wpLiveChatAdmin)try{window.wpLiveChatAdminApp=new e,console.log("WPLiveChatAdmin initialized")}catch(s){console.error("Failed to initialize WPLiveChatAdmin:",s)}else console.warn("wpLiveChatAdmin config missing; admin-chat.js will not initialize.")})}(jQuery),{}));