!function(e){"use strict";class s{constructor(){console.log("ğŸš€ WP Live Chat Initializing..."),window.wpLiveChat?(this.config=window.wpLiveChat,this.config.sessionId?(console.log("Config loaded successfully:",{hasSessionId:!!this.config.sessionId,hasAjaxUrl:!!this.config.ajaxurl,hasNonce:!!this.config.nonce}),this.pusher=null,this.channel=null,this.isConnected=!1,this.isOpen=!1,this.unreadCount=0,this.sessionId=this.config.sessionId,this.currentUser=this.config.currentUser||{},this.messageHistoryLoaded=!1,this.userInfoSubmitted=this.currentUser&&this.currentUser.info_completed||!1,this.messageCount=0,this.infoFormShown=!1,this.currentInputType=null,this.isWaitingForInput=!1,this.init()):console.error("âŒ sessionId is missing in config!")):console.error("âŒ wpLiveChat config is missing!")}init(){console.log("ğŸ”§ Starting initialization...");try{this.createDOM(),this.bindEvents(),this.fixPointerEvents(),this.initPusher(),this.startConnectionMonitor(),console.log("âœ… Initialization completed successfully")}catch(e){console.error("âŒ Initialization failed:",e),this.showGlobalError("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú†Øª: "+e.message)}}fixPointerEvents(){this.container&&(this.container.classList.contains("wp-live-chat-hidden")?(this.container.style.pointerEvents="none",this.toggle&&(this.toggle.style.pointerEvents="auto",this.toggle.parentNode&&(this.toggle.parentNode.style.pointerEvents="auto"))):this.container.style.pointerEvents="auto")}handleSystemMessage(e){console.log("ğŸ”§ Handling system message:",e),e.requires_input&&(this.currentInputType=e.input_type,this.isWaitingForInput=!0,this.updateInputPlaceholder())}updateInputPlaceholder(){if(!this.textarea)return;const e={phone:"Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯... (Ù…Ø«Ø§Ù„: 09123456789)",name:"Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...",default:"Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..."};this.textarea.placeholder=e[this.currentInputType]||e.default,this.textarea.value="",this.updateCharCounter(),this.validateInput()}showGlobalError(e){console.error("ğŸ’¥ Global Error:",e);const s=document.createElement("div");s.style.cssText="\n                position: fixed;\n                top: 20px;\n                right: 20px;\n                background: #dc3232;\n                color: white;\n                padding: 15px;\n                border-radius: 5px;\n                z-index: 1000000;\n                max-width: 300px;\n            ",s.innerHTML=`\n                <strong>Ø®Ø·Ø§ Ø¯Ø± Ú†Øª:</strong>\n                <p style="margin: 5px 0 0 0; font-size: 12px;">${e}</p>\n            `,document.body.appendChild(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},1e4)}createDOM(){if(console.log("Creating DOM elements..."),this.container=document.getElementById("wp-live-chat-container"),!this.container)return console.error("âŒ Chat container not found in DOM"),void this.showError("Ø¹Ù†ØµØ± Ú†Øª Ø¯Ø± ØµÙØ­Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯");console.log("âœ… Chat container found:",this.container),this.container.classList.remove("position-bottom-right"),this.container.classList.add("position-bottom-left"),this.widget=this.container.querySelector(".chat-widget"),this.toggle=this.container.querySelector(".chat-toggle"),this.messagesContainer=this.container.querySelector(".chat-messages"),this.textarea=this.container.querySelector(".chat-input-area textarea"),this.sendButton=this.container.querySelector(".send-button"),this.charCounter=this.container.querySelector(".char-counter"),this.statusIndicator=this.container.querySelector(".status-indicator"),this.statusDot=this.container.querySelector(".status-dot"),this.statusText=this.container.querySelector(".status-text"),this.widget?console.log("âœ… Chat widget found"):console.error("âŒ Chat widget not found"),this.toggle?console.log("âœ… Chat toggle found"):console.error("âŒ Chat toggle not found"),this.updateCharCounter(),this.validateInput(),this.container.classList.add("wp-live-chat-hidden"),console.log("âœ… DOM initialization completed")}bindEvents(){console.log("Binding events..."),this.toggle?(console.log("âœ… Toggle button found, adding click event"),this.toggle.addEventListener("click",e=>{console.log("ğŸ¯ Toggle clicked!",e),this.openChat()}),this.toggle.style.cursor="pointer"):console.error("âŒ Toggle button not found!");const e=this.container.querySelector(".chat-close");e&&e.addEventListener("click",()=>this.closeChat()),this.textarea&&(this.textarea.addEventListener("input",()=>{this.updateCharCounter(),this.validateInput()}),this.textarea.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})),this.sendButton&&this.sendButton.addEventListener("click",()=>this.sendMessage()),document.addEventListener("click",e=>{this.isOpen&&!this.container.contains(e.target)&&this.closeChat()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isOpen&&this.closeChat()}),console.log("âœ… Events bound successfully")}initPusher(){if(console.log("ğŸ”„ Initializing Pusher..."),!this.config.pusherKey||!this.config.pusherCluster)return console.error("âŒ Pusher configuration missing"),void this.showError("ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú†Øª Ú©Ø§Ù…Ù„ Ù†ÛŒØ³Øª");if("undefined"==typeof Pusher)return console.error("âŒ Pusher library not loaded"),void this.showError("Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú†Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯");try{const e={cluster:this.config.pusherCluster,authEndpoint:this.config.ajaxurl,auth:{params:{action:"auth_pusher_channel",nonce:this.config.nonce}},forceTLS:!0,enabledTransports:["ws","wss"]};console.log("ğŸ”§ Pusher config:",{key:this.config.pusherKey,cluster:this.config.pusherCluster,authEndpoint:this.config.ajaxurl}),this.pusher=new Pusher(this.config.pusherKey,e),this.pusher.connection.bind("initialized",()=>{console.log("ğŸ”Œ Pusher initialized")}),this.pusher.connection.bind("connecting",()=>{console.log("ğŸ”„ Pusher connecting..."),this.setStatus("connecting")}),this.pusher.connection.bind("connected",()=>{console.log("âœ… Pusher connected successfully"),console.log("ğŸ“¡ Socket ID:",this.pusher.connection.socket_id),this.isConnected=!0,this.setStatus("online"),this.subscribeToChannel()}),this.pusher.connection.bind("disconnected",()=>{console.log("ğŸ”´ Pusher disconnected"),this.isConnected=!1,this.setStatus("offline")}),this.pusher.connection.bind("error",e=>{console.error("âŒ Pusher connection error:",e),this.isConnected=!1,this.setStatus("offline");let s="Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú†Øª";e.error&&e.error.data&&(console.error("Error details:",e.error.data),4001===e.error.data.code?s="Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª - Ù„Ø·ÙØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯":4003===e.error.data.code?s="Ú©Ø§Ù†Ø§Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯":e.error.data.message&&(s=e.error.data.message)),this.showError(s)}),this.pusher.connection.bind("state_change",e=>{console.log("ğŸ”„ Pusher state change:",e)})}catch(e){console.error("âŒ Pusher initialization error:",e),this.isConnected=!1,this.setStatus("offline"),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ú†Øª: "+e.message)}}startConnectionMonitor(){setInterval(()=>{this.pusher&&this.channel&&"connected"===this.pusher.connection.state&&this.channel.subscribed&&!this.isConnected&&(console.log("ğŸ”„ Connection monitor: Fixing connection status"),this.isConnected=!0,this.setStatus("online"),this.validateInput())},5e3)}subscribeToChannel(){if(!this.pusher)return void console.error("âŒ Cannot subscribe: Pusher not initialized");const e=`private-chat-${this.sessionId}`;console.log("ğŸ“¡ Subscribing to channel:",e);try{this.channel=this.pusher.subscribe(e),this.channel.bind("pusher:subscription_succeeded",()=>{console.log("âœ… Channel subscription succeeded"),console.log("ğŸ”— Channel:",this.channel),this.isConnected=!0,this.validateInput()}),this.channel.bind("pusher:subscription_error",e=>{console.error("âŒ Channel subscription error:",e),console.error("Error details:",e),this.isConnected=!0,this.validateInput();let s="Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ú†Øª";403===e.status?s="Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ø§Ù†Ø§Ù„":404===e.status&&(s="Ú©Ø§Ù†Ø§Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯"),this.showError(s)}),this.channel.bind("client-message",e=>{console.log("ğŸ“¨ New message received:",e),this.handleIncomingMessage(e)})}catch(e){console.error("âŒ Channel subscription error:",e),this.isConnected=!1,this.validateInput()}}setStatus(e){const s={connecting:{text:"Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...",class:"connecting"},online:{text:"Ø¢Ù†Ù„Ø§ÛŒÙ†",class:"online"},offline:{text:"Ø¢ÙÙ„Ø§ÛŒÙ†",class:"offline"}},t=s[e]||s.offline;this.statusDot&&(this.statusDot.className=`status-dot ${t.class}`),this.statusText&&(this.statusText.textContent=t.text)}openChat(){try{if(console.log("ğŸ¯ openChat() called"),!this.container)return void console.error("âŒ Container is null in openChat!");this.container.classList.remove("wp-live-chat-hidden"),this.isOpen=!0,this.unreadCount=0,this.updateNotificationBadge(),this.fixPointerEvents(),console.log("âœ… Chat opened successfully"),console.log("ğŸ“Š User info check:",{userInfoSubmitted:this.userInfoSubmitted,currentUser:this.currentUser,info_completed:this.currentUser.info_completed}),this.userInfoSubmitted||this.currentUser.info_completed&&!1!==this.currentUser.info_completed||this.infoFormShown?(console.log("ğŸ’¬ User info complete, showing chat interface"),this.showChatInterface()):(console.log("ğŸ“ User info incomplete, showing form"),this.ensureFormElements(),this.hideChatInterface(),this.showUserInfoForm(),this.requestUserInfoFromSystem())}catch(e){console.error("âŒ Error in openChat:",e),this.showGlobalError("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú†Øª: "+e.message)}}requestUserInfoFromSystem(){if(console.log("ğŸ“¨ Requesting user info from system..."),0===this.messageCount&&!1===this.userInfoSubmitted){console.log("ğŸ“± Sending system request for user info");const e={id:"system_req_"+Date.now(),message:"ğŸ“± Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒÙ… Ø¨Ø§ Ø´Ù…Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§Ø´ÛŒÙ…:",user_id:0,user_name:"Ø³ÛŒØ³ØªÙ…",timestamp:(new Date).toISOString(),type:"system",requires_input:!0,input_type:"phone"};this.handleSystemMessage(e),this.displayMessage(e)}}ensureFormElements(){console.log("ğŸ” Ensuring form elements exist..."),this.container.querySelector("#user-info-form")||(console.error("âŒ User info form not found in DOM!"),this.createUserInfoForm()),this.userInfoForm=this.container.querySelector("#user-info-form"),this.contactInfoForm=this.container.querySelector("#contact-info-form"),this.chatInputArea=this.container.querySelector(".chat-input-area"),console.log("ğŸ“‹ Form elements check:",{userInfoForm:!!this.userInfoForm,contactInfoForm:!!this.contactInfoForm,chatInputArea:!!this.chatInputArea})}showUserInfoForm(){console.log("ğŸ“ Showing user info form"),this.hideChatInterface();const e=this.container.querySelector("#user-info-form");if(e){e.style.display="block",this.infoFormShown=!0;const s=e.querySelector("#user-name"),t=e.querySelector("#user-phone"),n=e.querySelector("#user-company");this.currentUser.name&&s&&(s.value=this.currentUser.name),this.currentUser.phone&&t&&(t.value=this.currentUser.phone),this.currentUser.company&&n&&(n.value=this.currentUser.company)}else console.error("âŒ User info form not found!")}showChatInterface(){console.log("ğŸ’¬ Showing chat interface");const e=this.container.querySelector("#user-info-form");e&&(e.style.display="none");const s=this.container.querySelector(".chat-input-area");s&&(s.style.display="block"),this.loadMessageHistory().then(()=>{console.log("âœ… Message history loaded successfully"),this.scrollToBottom()}).catch(e=>{console.error("âŒ Error loading message history:",e),this.scrollToBottom()}),this.textarea&&setTimeout(()=>{this.textarea.focus()},300)}hideChatInterface(){const e=this.container.querySelector(".chat-input-area");e&&(e.style.display="none")}setupInfoForm(){const e=this.container.querySelector("#contact-info-form");if(!e)return;e.addEventListener("submit",e=>{e.preventDefault(),this.submitUserInfo()});const s=e.querySelector("#user-phone"),t=e.querySelector("#user-name");s&&s.addEventListener("input",()=>{this.validatePhone(s.value)}),t&&t.addEventListener("input",()=>{this.validateName(t.value)})}validatePhone(e){const s=document.getElementById("phone-error");return e?/^09[0-9]{9}$/.test(e)?(this.hideError(s),!0):(this.showError(s,this.config.strings.invalidPhone),!1):(this.showError(s,this.config.strings.phoneRequired),!1)}validateName(e){const s=document.getElementById("name-error");return!e||e.trim().length<2?(this.showError(s,this.config.strings.nameRequired),!1):(this.hideError(s),!0)}showError(e,s){e&&(e.textContent=s,e.style.display="block")}hideError(e){e&&(e.textContent="",e.style.display="none")}async submitUserInfo(){console.log("ğŸ“¤ Submitting user info...");const s=this.container.querySelector("#contact-info-form");if(!s)return void console.error("âŒ Contact info form not found!");const t=new FormData(s),n=t.get("phone"),o=t.get("name"),i=t.get("company");if(console.log("ğŸ“‹ Form data:",{phone:n,name:o,company:i}),!this.validatePhone(n)||!this.validateName(o))return void console.log("âŒ Form validation failed");const r=s.querySelector(".submit-btn");r&&(r.disabled=!0,r.textContent="Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...");try{const s=await e.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"save_user_info",nonce:this.config.nonce,phone:n,name:o,company:i,session_id:this.sessionId},dataType:"json"});console.log("ğŸ“¤ Save user info response:",s),s.success?(console.log("âœ… User info saved successfully"),this.userInfoSubmitted=!0,this.currentUser={...this.currentUser,name:o,phone:n,company:i,info_completed:!0},this.config.currentUser=this.currentUser,console.log("ğŸ‘¤ Updated user data:",this.currentUser),this.showChatInterface(),this.displayWelcomeMessage(o),await this.sendWelcomeMessageToServer(o)):(console.error("âŒ Failed to save user info:",s.data),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª: "+s.data))}catch(e){console.error("âŒ Error saving user info:",e),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: "+e.message)}finally{r&&(r.disabled=!1,r.textContent="Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ")}}async sendWelcomeMessageToServer(s){try{const t=await e.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"send_welcome_message",nonce:this.config.nonce,session_id:this.sessionId,user_name:s},dataType:"json"});console.log("ğŸ‘‹ Welcome message sent:",t)}catch(e){console.error("âŒ Error sending welcome message:",e)}}displayWelcomeMessage(e){const s=`\n                <div class="system-message">\n                    <div class="message-content">\n                        <p>Ø³Ù„Ø§Ù… <strong>${this.escapeHtml(e)}</strong>! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ú†Ú¯ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ú©Ù…Ú© Ú©Ù†Ù…ØŸ</p>\n                    </div>\n                </div>\n            `;this.messagesContainer&&(this.messagesContainer.insertAdjacentHTML("beforeend",s),this.scrollToBottom())}closeChat(){console.log("Closing chat..."),this.container.classList.add("wp-live-chat-hidden"),this.isOpen=!1,this.fixPointerEvents(),console.log("âœ… Chat closed")}updateCharCounter(){if(!this.charCounter||!this.textarea)return;const e=this.textarea.value.length;this.charCounter.textContent=`${e}/500`,this.charCounter.classList.remove("near-limit","exceeded"),e>400&&this.charCounter.classList.add("near-limit"),e>500&&this.charCounter.classList.add("exceeded")}validateInput(){if(!this.textarea||!this.sendButton)return!1;const e=this.textarea.value.trim(),s=e.length>0&&e.length<=500;return this.sendButton.disabled=!s,s?(this.sendButton.style.background="#007cba",this.sendButton.style.cursor="pointer"):(this.sendButton.style.background="#ccc",this.sendButton.style.cursor="not-allowed"),console.log("Validation:",{messageLength:e.length,isValid:s,isConnected:this.isConnected}),s}async sendMessage(){if(this.isSendingMessage)return void console.log("â³ Message already being sent, please wait...");if(this.isWaitingForInput&&this.currentInputType)return void await this.handleUserInput();if(!this.textarea)return;const s=this.textarea.value.trim();if(this.validateInput()){this.isSendingMessage=!0,this.messageCount++,console.log("ğŸ“¤ Sending message:",s),this.sendButton&&(this.sendButton.disabled=!0,this.sendButton.textContent="Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...");try{const t="temp_"+Date.now(),n={id:t,message:s,user_id:this.currentUser.id,user_name:this.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±",timestamp:(new Date).toISOString(),type:"user",isTemp:!0,isLocal:!0};this.displayMessage(n,!1),this.textarea.value="",this.updateCharCounter(),this.validateInput(),console.log("âœ… Message displayed locally (temp)"),this.channel&&this.isConnected&&(this.channel.trigger("client-message",{...n,isBroadcast:!0}),console.log("âœ… Message sent via Pusher (temp)"));const o=await e.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"send_chat_message",nonce:this.config.nonce,message:s,user_id:this.currentUser.id,user_name:this.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±",session_id:this.sessionId},dataType:"json",timeout:5e3});console.log("ğŸ“¤ Server response:",o),o.success?(console.log("âœ… Message saved to database"),this.updateTempMessage(t,o.data.message_id)):(console.error("âŒ Server error:",o.data),this.markTempMessageAsFailed(t))}catch(e){console.error("âŒ Send message error:",e),this.markTempMessageAsFailed(tempMessageId)}finally{this.isSendingMessage=!1,this.sendButton&&(this.sendButton.disabled=!1,this.sendButton.textContent=this.config.strings.send,this.validateInput()),this.scrollToBottom()}}else console.log("Message validation failed")}markTempMessageAsFailed(e){const s=this.messagesContainer.querySelector(`[data-message-id="${e}"]`);if(s){s.classList.add("failed-message");const t=document.createElement("div");t.className="message-status failed",t.textContent="âš ï¸",t.title="Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚ - Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯",s.appendChild(t),console.log("âš ï¸ Temp message marked as failed:",e)}}updateTempMessage(e,s){const t=this.messagesContainer.querySelector(`[data-message-id="${e}"]`);if(t){t.dataset.messageId=s,t.classList.remove("temp-message");const e=document.createElement("div");e.className="message-status delivered",e.textContent="âœ“âœ“",t.appendChild(e),console.log("âœ… Temp message updated with real ID:",s)}}async handleUserInput(){if(!this.textarea)return;const e=this.textarea.value.trim();if(e){this.sendButton&&(this.sendButton.disabled=!0,this.sendButton.textContent="Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...");try{let s;"phone"===this.currentInputType?s=await this.savePhoneNumber(e):"name"===this.currentInputType&&(s=await this.saveUserName(e)),s&&s.success?(console.log("âœ… User input saved successfully"),this.displayUserInputMessage(e),this.currentInputType=null,this.isWaitingForInput=!1,this.updateInputPlaceholder()):(console.error("âŒ Failed to save user input"),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª"))}catch(e){console.error("âŒ Error saving user input:",e),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±")}finally{this.sendButton&&(this.sendButton.disabled=!1,this.sendButton.textContent=this.config.strings.send,this.validateInput())}}else console.log("Input value is empty")}saveUserName(s){return new Promise((t,n)=>{e.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"save_user_name",nonce:this.config.nonce,name:s,session_id:this.sessionId},dataType:"json"}).done(t).fail(n)})}savePhoneNumber(s){return new Promise((t,n)=>{e.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"save_user_phone",nonce:this.config.nonce,phone:s,session_id:this.sessionId},dataType:"json"}).done(t).fail(n)})}displayUserInputMessage(e){const s={id:"temp_input_"+Date.now(),message:e,user_id:this.currentUser.id,user_name:this.currentUser.name,timestamp:(new Date).toISOString(),type:"user"};this.displayMessage(s)}replaceTempMessage(e,s){const t=this.messagesContainer.querySelector(`[data-message-id="${e}"]`);t&&(t.dataset.messageId=s,t.classList.remove("temp-message"),console.log("âœ… Temp message replaced with real ID:",s))}markMessageAsPermanent(e){const s=this.messagesContainer.querySelector(`[data-message-id="${e}"]`);s&&(s.classList.remove("temp-message"),console.log("âœ… Temp message marked as permanent"))}updateMessageId(e,s){const t=this.messagesContainer.querySelector(`[data-message-id="${e}"]`);t&&(t.dataset.messageId=s)}displayMessage(e,s=!0){if(!this.messagesContainer)return;if(this.isDuplicateMessage(e.id))return void console.log("âš ï¸ Duplicate message, not displaying:",e.id);const t=this.createMessageElement(e);this.messagesContainer.appendChild(t),this.saveMessageId(e.id),s&&this.scrollToBottom()}createMessageElement(e){const s=document.createElement("div");s.className=`message ${e.type}-message`,e.isTemp&&s.classList.add("temp-message"),e.isLocal&&s.classList.add("local-message"),e.isFromHistory&&s.classList.add("history-message"),s.dataset.messageId=e.id;const t=new Date(e.timestamp).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"});let n=e.user_name;if("admin"===e.type?n="Ù¾Ø´ØªÛŒØ¨Ø§Ù†":n&&"undefined"!==n||(n="Ú©Ø§Ø±Ø¨Ø±"),s.innerHTML=`\n                <div class="message-header">\n                    <span class="message-sender">${this.escapeHtml(n)}</span>\n                    <span class="message-time">${t}</span>\n                </div>\n                <div class="message-content">\n                    <p>${this.escapeHtml(e.message)}</p>\n                </div>\n            `,"user"===e.type&&!e.isTemp){const e=document.createElement("div");e.className="message-status delivered",e.textContent="âœ“âœ“",s.appendChild(e)}return s}handleIncomingMessage(e){console.log("ğŸ“¨ New message received:",e),this.isDuplicateMessage(e.id)?console.log("âš ï¸ Duplicate message detected, ignoring:",e.id):"user"===e.type&&e.isBroadcast&&e.user_id===this.currentUser.id?console.log("ğŸ“¨ Ignoring self-broadcast message:",e.id):"user"===e.type&&e.isTemp&&e.user_id===this.currentUser.id?console.log("ğŸ“¨ Ignoring own temp message:",e.id):("system"===e.type&&e.requires_input&&(console.log("ğŸ”§ System message requires input:",e.input_type),this.handleSystemMessage(e)),this.displayMessage(e),this.saveMessageId(e.id),this.isOpen||(this.unreadCount++,this.updateNotificationBadge(),this.showDesktopNotification(e)))}saveMessageId(e){const s=`wp_live_chat_msg_${e}`;localStorage.setItem(s,"1"),this.cleanupMessageIds()}cleanupMessageIds(){const e=[];for(let s=0;s<localStorage.length;s++){const t=localStorage.key(s);t&&t.startsWith("wp_live_chat_msg_")&&e.push(t)}e.length>100&&e.sort().slice(0,e.length-100).forEach(e=>{localStorage.removeItem(e)})}isDuplicateMessage(e){const s=`wp_live_chat_msg_${e}`;return!!localStorage.getItem(s)||!(!this.messagesContainer||!this.messagesContainer.querySelector(`[data-message-id="${e}"]`))}showTypingIndicator(e){console.log("User is typing:",e)}updateNotificationBadge(){if(!this.toggle)return;const e=this.toggle.querySelector(".notification-badge");e&&(this.unreadCount>0?(e.textContent=this.unreadCount>9?"9+":this.unreadCount,e.style.display="flex"):(e.textContent="",e.style.display="none"))}scrollToBottom(){this.messagesContainer&&(this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight)}loadMessageHistory(){return this.messageHistoryLoading?(console.log("â³ Message history is already loading..."),Promise.resolve()):(console.log("ğŸ“š Loading message history for session:",this.sessionId),this.messageHistoryLoading=!0,new Promise((s,t)=>{e.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"get_chat_history",nonce:this.config.nonce,session_id:this.sessionId,force_reload:!0},dataType:"json",timeout:1e4}).done(e=>{console.log("ğŸ“š History API Response:",e),e.success&&e.data&&Array.isArray(e.data)?(console.log("ğŸ“œ Found messages in history:",e.data.length),this.renderMessageHistory(e.data),this.messageHistoryLoaded=!0,console.log("âœ… Message history loaded successfully"),s(e.data)):(console.warn("âš ï¸ No message history found"),this.messageHistoryLoaded=!0,s([]))}).fail(e=>{console.error("âŒ Error loading message history:",e),this.messageHistoryLoaded=!0,t(e)}).always(()=>{this.messageHistoryLoading=!1})}))}clearExistingMessages(){if(!this.messagesContainer)return;const e=this.messagesContainer.querySelectorAll(".message:not(.welcome-message)");e.forEach(e=>{e.remove()}),console.log(`ğŸ§¹ Cleared ${e.length} existing messages`)}renderMessageHistory(e){if(!this.messagesContainer)return void console.error("âŒ Messages container not found");console.log("ğŸ¨ Rendering message history:",e.length);const s=this.messagesContainer.querySelectorAll(".message:not(.system-message):not(.welcome-message)");s.forEach(e=>{e.classList.contains("local-message")||e.remove()}),console.log(`ğŸ§¹ Cleared ${s.length} old messages`),e&&0!==e.length?(e.forEach(e=>{this.isDuplicateMessage(e.id)||this.displayMessage({id:e.id,message:e.message_content,user_id:e.user_id,user_name:e.user_name,timestamp:e.created_at,type:e.message_type,isFromHistory:!0},!1)}),this.scrollToBottom(),console.log(`âœ… Rendered ${e.length} messages from history`)):console.log("ğŸ“­ No messages to display from history")}showError(e){if(!this.messagesContainer)return;const s=document.createElement("div");s.className="chat-error",s.innerHTML=`\n                <div class="error-icon">âš ï¸</div>\n                <p class="error-message">${e}</p>\n                <button class="retry-button">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button>\n            `,s.querySelector(".retry-button").addEventListener("click",()=>{s.remove(),this.initPusher()}),this.messagesContainer.appendChild(s)}showDesktopNotification(e){"Notification"in window&&"granted"===Notification.permission&&new Notification("Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯",{body:`${e.user_name}: ${e.message}`,icon:"/wp-content/plugins/wp-live-chat/assets/images/icon.png"})}escapeHtml(e){const s=document.createElement("div");return s.textContent=e,s.innerHTML}enableManually(){console.log("ğŸ”„ Manually enabling chat..."),this.isConnected=!0,this.setStatus("online"),this.validateInput(),console.log("âœ… Chat manually enabled")}destroy(){this.pusher&&this.pusher.disconnect(),console.log("âœ… Chat destroyed")}}document.addEventListener("DOMContentLoaded",function(){document.getElementById("wp-live-chat-container")&&(window.wpLiveChatInstance=new s,console.log("ğŸ‰ WP Live Chat started successfully!")),document.querySelectorAll(".wp-live-chat-button").forEach(e=>{e.addEventListener("click",function(){window.wpLiveChatInstance&&window.wpLiveChatInstance.openChat()})})}),window.WPLiveChat=s}(jQuery);