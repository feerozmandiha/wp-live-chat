!function(s){"use strict";class e{constructor(){this.config=window.wpLiveChatAdmin||{},this.currentSession=null,this.sessions=[],this.pusher=null,this.channel=null,this.isLoading=!1,this.retryCount=0,this.maxRetries=3,this.init()}init(){this.bindEvents(),this.initPusher(),this.loadSessions(),s(document).ajaxError((s,e,n,i)=>{console.error("AJAX Error:",i,n.url),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±")})}bindEvents(){s("#refresh-sessions").on("click",()=>this.loadSessions()),s("#admin-send-button").on("click",()=>this.sendMessage()),s("#admin-message-input").on("keydown",s=>{"Enter"!==s.key||s.shiftKey||(s.preventDefault(),this.sendMessage())}),setInterval(()=>{this.currentSession&&this.loadSessionMessages(this.currentSession.session_id)},3e4)}initPusher(){if(!this.config.pusherKey||"undefined"==typeof Pusher)return console.error("Pusher not configured"),void this.showError("Ø³Ø±ÙˆÛŒØ³ Pusher Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª");try{this.pusher=new Pusher(this.config.pusherKey,{cluster:this.config.pusherCluster,forceTLS:!0,authEndpoint:this.config.ajaxurl,auth:{params:{action:"auth_pusher_channel_admin",nonce:this.config.nonce}}}),this.pusher.subscribe("admin-notifications").bind("new-chat",s=>{this.handleNewChatNotification(s)}),this.pusher.connection.bind("state_change",s=>{console.log("Pusher connection state:",s.current)})}catch(s){console.error("Error initializing Pusher:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Pusher")}}async loadSessions(){if(!this.isLoading){this.isLoading=!0,s("#refresh-sessions").prop("disabled",!0).text("Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...");try{const e=await s.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"get_chat_sessions",nonce:this.config.nonce},dataType:"json",timeout:1e4});if(!e.success)throw new Error(e.data||"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ù„Ø³Ø§Øª");this.sessions=e.data,this.renderSessions(),this.retryCount=0}catch(s){console.error("Error loading sessions:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ù„Ø³Ø§Øª: "+s.message),this.retryCount<this.maxRetries&&(this.retryCount++,setTimeout(()=>this.loadSessions(),2e3))}finally{this.isLoading=!1,s("#refresh-sessions").prop("disabled",!1).text("Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ")}}}renderSessions(){const e=s("#sessions-list");e.empty(),0!==this.sessions.length?this.sessions.forEach(n=>{const i=s(`\n                    <div class="session-item" data-session-id="${n.session_id}">\n                        <div class="session-info">\n                            <div class="session-user">\n                                <strong>${this.escapeHtml(n.user_name||"Ú©Ø§Ø±Ø¨Ø±")}</strong>\n                                ${n.user_phone?`<div class="session-phone">${n.user_phone}</div>`:""}\n                            </div>\n                            <div class="session-meta">\n                                <span class="message-count">${n.message_count||0} Ù¾ÛŒØ§Ù…</span>\n                                <span class="last-activity">${this.formatTime(n.last_activity)}</span>\n                            </div>\n                        </div>\n                        ${n.unread_count>0?`<span class="unread-badge">${n.unread_count}</span>`:""}\n                    </div>\n                `);i.on("click",()=>this.selectSession(n)),e.append(i)}):e.html('<div class="no-sessions">'+this.config.strings.noActiveChats+"</div>")}async selectSession(e){s(".session-item").removeClass("active"),s(`.session-item[data-session-id="${e.session_id}"]`).addClass("active"),this.currentSession=e,s("#current-session-title").text(e.user_name||"Ú©Ø§Ø±Ø¨Ø±"),s("#session-status").text("active"===e.status?"Ø¢Ù†Ù„Ø§ÛŒÙ†":"Ø¢ÙÙ„Ø§ÛŒÙ†").removeClass("status-offline status-online").addClass("active"===e.status?"status-online":"status-offline"),s("#admin-chat-input").show(),s("#admin-message-input").focus(),await this.loadSessionMessages(e.session_id),this.subscribeToSession(e.session_id)}async loadSessionMessages(e){try{const n=await s.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"get_session_messages",nonce:this.config.nonce,session_id:e},dataType:"json",timeout:1e4});if(!n.success)throw new Error(n.data||"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§");this.renderMessages(n.data)}catch(s){console.error("Error loading messages:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§")}}renderMessages(e){const n=s("#admin-chat-messages");n.empty(),e&&0!==e.length?(e.forEach(e=>{const i=s(`\n                    <div class="message ${"admin"===e.message_type?"admin":"user"}">\n                        <div class="message-header">\n                            <span class="message-sender">\n                                ${"admin"===e.message_type?"ğŸ‘¨â€ğŸ’¼ Ù¾Ø´ØªÛŒØ¨Ø§Ù†":"ğŸ‘¤ "+this.escapeHtml(e.user_name||"Ú©Ø§Ø±Ø¨Ø±")}\n                            </span>\n                            <span class="message-time">${this.formatTime(e.created_at)}</span>\n                        </div>\n                        <div class="message-content">\n                            <p>${this.escapeHtml(e.message_content)}</p>\n                        </div>\n                    </div>\n                `);n.append(i)}),n.scrollTop(n[0].scrollHeight)):n.html('<div class="no-messages">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ø±Ø¯ Ùˆ Ø¨Ø¯Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>')}async sendMessage(){if(!this.currentSession)return void this.showError("Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");const e=s("#admin-message-input"),n=e.val().trim();if(!n)return void this.showError("Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");const i=s("#admin-send-button");i.prop("disabled",!0).text("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...");try{const i=await s.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"send_admin_message",nonce:this.config.nonce,session_id:this.currentSession.session_id,message:n},dataType:"json",timeout:1e4});if(!i.success)throw new Error(i.data||"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…");e.val(""),this.addLocalMessage({message_content:n,user_name:"Ù¾Ø´ØªÛŒØ¨Ø§Ù†",message_type:"admin",created_at:(new Date).toISOString()}),this.showSuccess("Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯")}catch(s){console.error("Error sending message:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: "+s.message)}finally{i.prop("disabled",!1).text("Ø§Ø±Ø³Ø§Ù„")}}addLocalMessage(e){const n=s("#admin-chat-messages"),i=s(`\n                <div class="message admin">\n                    <div class="message-header">\n                        <span class="message-sender">ğŸ‘¨â€ğŸ’¼ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</span>\n                        <span class="message-time">${this.formatTime(e.created_at)}</span>\n                    </div>\n                    <div class="message-content">\n                        <p>${this.escapeHtml(e.message_content)}</p>\n                    </div>\n                </div>\n            `);n.append(i),n.scrollTop(n[0].scrollHeight)}subscribeToSession(s){if(!this.pusher)return void console.warn("Pusher not initialized");if(this.channel)try{this.pusher.unsubscribe(this.channel.name)}catch(s){console.warn("Error unsubscribing from channel:",s)}const e=`chat-${s}`;try{this.channel=this.pusher.subscribe(e),console.log("Subscribed to channel:",e),this.channel.bind("new-message",e=>{console.log("New message received:",e),this.currentSession&&this.currentSession.session_id===s&&(this.loadSessionMessages(s),"user"===e.type&&this.showNotification("Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯",`Ú©Ø§Ø±Ø¨Ø±: ${e.user_name}`))}),this.channel.bind("pusher:subscription_succeeded",()=>{console.log("Successfully subscribed to channel:",e)}),this.channel.bind("pusher:subscription_error",s=>{console.error("Subscription error:",s)})}catch(s){console.error("Error subscribing to channel:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ú†Øª")}}handleNewChatNotification(s){this.loadSessions(),"Notification"in window&&"granted"===Notification.permission&&new Notification("Ú†Øª Ø¬Ø¯ÛŒØ¯",{body:`Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯: ${s.user_name}`,icon:"/wp-content/plugins/wp-live-chat/assets/images/icon.png"}),this.showNotification("Ú†Øª Ø¬Ø¯ÛŒØ¯",`Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯: ${s.user_name}`)}showError(s){this.showMessage(s,"error")}showSuccess(s){this.showMessage(s,"success")}showMessage(e,n="info"){const i=s('<div class="admin-message-alert"></div>').addClass(`alert-${n}`).text(e).prependTo("#chat-admin-app");setTimeout(()=>i.fadeOut(300,()=>i.remove()),5e3)}showNotification(e,n){const i=s(`\n                <div class="notification-toast">\n                    <div class="notification-title">${e}</div>\n                    <div class="notification-body">${n}</div>\n                </div>\n            `).appendTo("body");setTimeout(()=>i.fadeOut(300,()=>i.remove()),5e3)}formatTime(s){if(!s)return"--:--";try{const e=new Date(s);return isNaN(e.getTime())?s:e.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit",hour12:!1})}catch(s){return"--:--"}}escapeHtml(s){const e=document.createElement("div");return e.textContent=s,e.innerHTML}}s(document).ready(function(){if(window.wpLiveChatAdmin)try{window.wpLiveChatAdminApp=new e,console.log("WP Live Chat Admin initialized successfully")}catch(s){console.error("Failed to initialize WP Live Chat Admin:",s)}else console.error("WP Live Chat Admin configuration not found")})}(jQuery);