!function(s,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["admin-chat"]=e():s["admin-chat"]=e()}(self,()=>(function(s){"use strict";class e{constructor(){this.config=window.wpLiveChatAdmin||{},this.currentSession=null,this.sessions=[],this.pusher=null,this.channel=null,this.isLoading=!1,this.retryCount=0,this.maxRetries=5,this.reconnectTimer=null,this.init()}init(){this.bindEvents(),this.initPusher(),this.loadSessions(),s(document).ajaxError((s,e,n,t)=>{console.error("AJAX Error:",t,n.url),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±")}),this.sessionsRefreshInterval=setInterval(()=>{this.loadSessions(!1)},3e4)}bindEvents(){s("#refresh-sessions").on("click",()=>this.loadSessions(!0)),s("#admin-send-button").on("click",()=>this.sendMessage()),s("#admin-message-input").on("keydown",s=>{"Enter"!==s.key||s.shiftKey||(s.preventDefault(),this.sendMessage())})}initPusher(){if(this.config.pusherKey&&"undefined"!=typeof Pusher){if(this.pusher)try{this.cleanupPusher()}catch(s){console.warn(s)}try{this.pusher=new Pusher(this.config.pusherKey,{cluster:this.config.pusherCluster||"mt1",forceTLS:!0,authEndpoint:this.config.ajaxurl,auth:{params:{action:"pusher_auth",nonce:this.config.nonce}},activityTimeout:12e4,pongTimeout:3e4,disableStats:!0}),this.pusher.subscribe("admin-notifications").bind("new-chat",s=>this.handleNewChatNotification(s)),this.pusher.connection.bind("state_change",s=>{console.log("Pusher connection state (admin):",s.current),"disconnected"!==s.current&&"failed"!==s.current||this.attemptReconnect()})}catch(s){console.error("Error initializing admin Pusher:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§")}}else console.warn("Pusher not configured for admin panel")}cleanupPusher(){try{if(this.pusher){try{this.pusher.unsubscribe("admin-notifications")}catch(s){}try{this.pusher.disconnect()}catch(s){}}}finally{this.pusher=null}}attemptReconnect(){if(!this.config.pusherKey)return;if(this.retryCount>=this.maxRetries)return void console.warn("Admin: max reconnect attempts reached");this.retryCount++;const s=Math.min(1e3*Math.pow(2,this.retryCount),3e4);console.log(`Admin: reconnect attempt ${this.retryCount} in ${s}ms`),clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout(()=>this.initPusher(),s)}async loadSessions(e=!0){if(!this.isLoading){this.isLoading=!0,e&&s("#refresh-sessions").prop("disabled",!0).text("Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...");try{const e=await s.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"wp_live_chat_get_sessions",nonce:this.config.nonce},dataType:"json",timeout:1e4});if(!e.success)throw new Error(e.data||"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¬Ù„Ø³Ø§Øª");this.sessions=e.data||[],this.renderSessions(),this.retryCount=0}catch(s){console.error("Error loading sessions:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ù„Ø³Ø§Øª"),this.retryCount<this.maxRetries&&(this.retryCount++,setTimeout(()=>this.loadSessions(!1),2e3))}finally{this.isLoading=!1,e&&s("#refresh-sessions").prop("disabled",!1).text("Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ")}}}renderSessions(){const e=s("#sessions-list");e.empty(),0!==this.sessions.length?this.sessions.forEach(n=>{const t=s(`\n                    <div class="session-item ${n.unread_count>0?"has-unread":""}" data-session-id="${n.session_id}">\n                        <div class="session-info">\n                            <div class="session-user">\n                                <strong>${this.escapeHtml(n.user_name||"Ú©Ø§Ø±Ø¨Ø±")}</strong>\n                                ${n.user_phone?`<div class="session-phone">${n.user_phone}</div>`:""}\n                            </div>\n                            <div class="session-meta">\n                                <span class="message-count">${n.message_count||0} Ù¾ÛŒØ§Ù…</span>\n                                <span class="last-activity">${this.formatTime(n.last_activity)}</span>\n                            </div>\n                        </div>\n                        ${n.unread_count>0?`<span class="unread-badge">${n.unread_count}</span>`:""}\n                    </div>\n                `);t.on("click",()=>this.selectSession(n)),e.append(t)}):e.html('<div class="no-sessions">'+this.config.strings.noActiveChats+"</div>")}async selectSession(e){s(".session-item").removeClass("active"),s(`.session-item[data-session-id="${e.session_id}"]`).addClass("active").removeClass("has-unread"),this.currentSession=e,e.unread_count&&e.unread_count>0&&await this.markSessionAsRead(e.session_id),s("#current-session-title").text(e.user_name||"Ú©Ø§Ø±Ø¨Ø±"),s("#session-status").text("active"===e.status?"Ø¢Ù†Ù„Ø§ÛŒÙ†":"Ø¢ÙÙ„Ø§ÛŒÙ†").removeClass("status-offline status-online").addClass("active"===e.status?"status-online":"status-offline"),s("#admin-chat-input").show(),s("#admin-message-input").focus(),await this.loadSessionMessages(e.session_id),this.subscribeToSession(e.session_id)}async markSessionAsRead(e){try{const n=await s.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"wp_live_chat_mark_read",nonce:this.config.nonce,session_id:e},dataType:"json"});if(n.success){s(`.session-item[data-session-id="${e}"]`).find(".unread-badge").remove();const n=this.sessions.find(s=>s.session_id===e);n&&(n.unread_count=0,n.has_unread=!1)}else console.warn("mark read response error",n)}catch(s){console.error("Error marking session as read:",s)}}async loadSessionMessages(e){try{const n=await s.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"wp_live_chat_get_messages",nonce:this.config.nonce,session_id:e},dataType:"json",timeout:1e4});if(!n.success)throw new Error(n.data||"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§");this.renderMessages(n.data||[])}catch(s){console.error("Error loading messages:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§")}}renderMessages(e){const n=s("#admin-chat-messages");n.empty(),e&&0!==e.length?(e.forEach(e=>{const t="admin"===e.message_type?"admin":"user",i=s(`\n                    <div class="message ${t}">\n                        <div class="message-header">\n                            <span class="message-sender">${"admin"===t?"ğŸ‘¨â€ğŸ’¼ Ù¾Ø´ØªÛŒØ¨Ø§Ù†":"ğŸ‘¤ "+this.escapeHtml(e.user_name||"Ú©Ø§Ø±Ø¨Ø±")}</span>\n                            <span class="message-time">${this.formatTime(e.created_at)}</span>\n                        </div>\n                        <div class="message-content"><p>${this.escapeHtml(e.message_content)}</p></div>\n                    </div>\n                `);n.append(i)}),n.scrollTop(n[0].scrollHeight)):n.html('<div class="no-messages">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ø±Ø¯ Ùˆ Ø¨Ø¯Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>')}async sendMessage(){if(!this.currentSession)return void this.showError("Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");const e=s("#admin-message-input"),n=e.val().trim();if(!n)return void this.showError("Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");const t=s("#admin-send-button");t.prop("disabled",!0).text("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...");try{const t=await s.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"wp_live_chat_send_admin_message",nonce:this.config.nonce,session_id:this.currentSession.session_id,message:n},dataType:"json",timeout:1e4});if(!t.success)throw new Error(t.data||"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…");e.val(""),this.addLocalMessage({message_content:n,user_name:"Ù¾Ø´ØªÛŒØ¨Ø§Ù†",message_type:"admin",created_at:(new Date).toISOString()}),this.showSuccess("Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯"),this.loadSessions(!1)}catch(s){console.error("Error sending message:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…")}finally{t.prop("disabled",!1).text("Ø§Ø±Ø³Ø§Ù„")}}addLocalMessage(e){const n=s("#admin-chat-messages"),t=s(`\n                <div class="message admin">\n                    <div class="message-header">\n                        <span class="message-sender">ğŸ‘¨â€ğŸ’¼ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</span>\n                        <span class="message-time">${this.formatTime(e.created_at)}</span>\n                    </div>\n                    <div class="message-content"><p>${this.escapeHtml(e.message_content)}</p></div>\n                </div>\n            `);n.append(t),n.scrollTop(n[0].scrollHeight)}subscribeToSession(s){try{if(this.channel&&this.pusher){try{this.pusher.unsubscribe(this.channel.name)}catch(s){console.warn(s)}this.channel=null}}catch(s){console.warn(s)}if(!this.pusher)return;const e=`private-chat-${s}`;try{this.channel=this.pusher.subscribe(e),this.channel.bind("new-message",e=>{this.currentSession&&this.currentSession.session_id===s&&this.loadSessionMessages(s),"user"===e.type&&this.showNotification("Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯",`Ú©Ø§Ø±Ø¨Ø±: ${e.user_name||""}`)}),this.channel.bind("pusher:subscription_error",s=>{console.error("subscription error admin channel",s)})}catch(s){console.error("Error subscribing to session channel:",s)}}handleNewChatNotification(s){this.loadSessions(!1),"Notification"in window&&"granted"===Notification.permission&&new Notification("Ú†Øª Ø¬Ø¯ÛŒØ¯",{body:`Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯: ${s.user_name}`,icon:"/wp-content/plugins/wp-live-chat/assets/images/icon.png"}),this.showNotification("Ú†Øª Ø¬Ø¯ÛŒØ¯",`Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯: ${s.user_name}`)}showError(s){this.showMessage(s,"error")}showSuccess(s){this.showMessage(s,"success")}showMessage(e,n="info"){const t=s('<div class="admin-message-alert"></div>').addClass(`alert-${n}`).text(e).prependTo("#chat-admin-app");setTimeout(()=>t.fadeOut(300,()=>t.remove()),5e3)}showNotification(e,n){const t=s(`<div class="notification-toast"><div class="notification-title">${e}</div><div class="notification-body">${n}</div></div>`).appendTo("body");setTimeout(()=>t.fadeOut(300,()=>t.remove()),5e3)}formatTime(s){if(!s)return"--:--";try{const e=new Date(s);return isNaN(e.getTime())?s:e.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit",hour12:!1})}catch(s){return"--:--"}}escapeHtml(s){const e=document.createElement("div");return e.textContent=s,e.innerHTML}}s(document).ready(function(){if(window.wpLiveChatAdmin)try{window.wpLiveChatAdminApp=new e,console.log("WP Live Chat Admin initialized successfully")}catch(s){console.error("Failed to initialize WP Live Chat Admin:",s)}else console.error("WP Live Chat Admin configuration not found")})}(jQuery),{}));