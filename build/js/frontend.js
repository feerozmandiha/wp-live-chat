!function(e){"use strict";class t{constructor(){console.log("ğŸš€ WP Live Chat Initializing..."),window.wpLiveChat?(this.config=window.wpLiveChat,this.config.sessionId?(console.log("Config loaded successfully:",{hasSessionId:!!this.config.sessionId,hasAjaxUrl:!!this.config.ajaxurl,hasNonce:!!this.config.nonce}),this.pusher=null,this.channel=null,this.isConnected=!1,this.isOpen=!1,this.unreadCount=0,this.sessionId=this.config.sessionId,this.currentUser=this.config.currentUser||{},this.messageHistoryLoaded=!1,this.userInfoSubmitted=this.currentUser&&this.currentUser.info_completed||!1,this.messageCount=0,this.infoFormShown=!1,this.init()):console.error("âŒ sessionId is missing in config!")):console.error("âŒ wpLiveChat config is missing!")}init(){console.log("ğŸ”§ Starting initialization...");try{this.createDOM(),this.bindEvents(),this.initPusher(),this.startConnectionMonitor(),console.log("âœ… Initialization completed successfully")}catch(e){console.error("âŒ Initialization failed:",e),this.showGlobalError("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú†Øª: "+e.message)}}showGlobalError(e){console.error("ğŸ’¥ Global Error:",e);const t=document.createElement("div");t.style.cssText="\n                position: fixed;\n                top: 20px;\n                right: 20px;\n                background: #dc3232;\n                color: white;\n                padding: 15px;\n                border-radius: 5px;\n                z-index: 1000000;\n                max-width: 300px;\n            ",t.innerHTML=`\n                <strong>Ø®Ø·Ø§ Ø¯Ø± Ú†Øª:</strong>\n                <p style="margin: 5px 0 0 0; font-size: 12px;">${e}</p>\n            `,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},1e4)}createDOM(){if(console.log("Creating DOM elements..."),this.container=document.getElementById("wp-live-chat-container"),!this.container)return console.error("âŒ Chat container not found in DOM"),void this.showError("Ø¹Ù†ØµØ± Ú†Øª Ø¯Ø± ØµÙØ­Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯");console.log("âœ… Chat container found:",this.container),this.container.classList.remove("position-bottom-right"),this.container.classList.add("position-bottom-left"),this.widget=this.container.querySelector(".chat-widget"),this.toggle=this.container.querySelector(".chat-toggle"),this.messagesContainer=this.container.querySelector(".chat-messages"),this.textarea=this.container.querySelector(".chat-input-area textarea"),this.sendButton=this.container.querySelector(".send-button"),this.charCounter=this.container.querySelector(".char-counter"),this.statusIndicator=this.container.querySelector(".status-indicator"),this.statusDot=this.container.querySelector(".status-dot"),this.statusText=this.container.querySelector(".status-text"),this.widget?console.log("âœ… Chat widget found"):console.error("âŒ Chat widget not found"),this.toggle?console.log("âœ… Chat toggle found"):console.error("âŒ Chat toggle not found"),this.updateCharCounter(),this.validateInput(),this.container.classList.add("wp-live-chat-hidden"),console.log("âœ… DOM initialization completed")}bindEvents(){console.log("Binding events..."),this.toggle?(console.log("âœ… Toggle button found, adding click event"),this.toggle.addEventListener("click",e=>{console.log("ğŸ¯ Toggle clicked!",e),this.openChat()}),this.toggle.style.cursor="pointer"):console.error("âŒ Toggle button not found!");const e=this.container.querySelector(".chat-close");e&&e.addEventListener("click",()=>this.closeChat()),this.textarea&&(this.textarea.addEventListener("input",()=>{this.updateCharCounter(),this.validateInput()}),this.textarea.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})),this.sendButton&&this.sendButton.addEventListener("click",()=>this.sendMessage()),document.addEventListener("click",e=>{this.isOpen&&!this.container.contains(e.target)&&this.closeChat()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isOpen&&this.closeChat()}),console.log("âœ… Events bound successfully")}initPusher(){if(console.log("ğŸ”„ Initializing Pusher..."),!this.config.pusherKey||!this.config.pusherCluster)return console.error("âŒ Pusher configuration missing"),void this.showError("ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú†Øª Ú©Ø§Ù…Ù„ Ù†ÛŒØ³Øª");if("undefined"==typeof Pusher)return console.error("âŒ Pusher library not loaded"),void this.showError("Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú†Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯");try{const e={cluster:this.config.pusherCluster,authEndpoint:this.config.ajaxurl,auth:{params:{action:"auth_pusher_channel",nonce:this.config.nonce}},forceTLS:!0,enabledTransports:["ws","wss"]};console.log("ğŸ”§ Pusher config:",{key:this.config.pusherKey,cluster:this.config.pusherCluster,authEndpoint:this.config.ajaxurl}),this.pusher=new Pusher(this.config.pusherKey,e),this.pusher.connection.bind("initialized",()=>{console.log("ğŸ”Œ Pusher initialized")}),this.pusher.connection.bind("connecting",()=>{console.log("ğŸ”„ Pusher connecting..."),this.setStatus("connecting")}),this.pusher.connection.bind("connected",()=>{console.log("âœ… Pusher connected successfully"),console.log("ğŸ“¡ Socket ID:",this.pusher.connection.socket_id),this.isConnected=!0,this.setStatus("online"),this.subscribeToChannel()}),this.pusher.connection.bind("disconnected",()=>{console.log("ğŸ”´ Pusher disconnected"),this.isConnected=!1,this.setStatus("offline")}),this.pusher.connection.bind("error",e=>{console.error("âŒ Pusher connection error:",e),this.isConnected=!1,this.setStatus("offline");let t="Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú†Øª";e.error&&e.error.data&&(console.error("Error details:",e.error.data),4001===e.error.data.code?t="Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª - Ù„Ø·ÙØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯":4003===e.error.data.code?t="Ú©Ø§Ù†Ø§Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯":e.error.data.message&&(t=e.error.data.message)),this.showError(t)}),this.pusher.connection.bind("state_change",e=>{console.log("ğŸ”„ Pusher state change:",e)})}catch(e){console.error("âŒ Pusher initialization error:",e),this.isConnected=!1,this.setStatus("offline"),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ú†Øª: "+e.message)}}startConnectionMonitor(){setInterval(()=>{this.pusher&&this.channel&&"connected"===this.pusher.connection.state&&this.channel.subscribed&&!this.isConnected&&(console.log("ğŸ”„ Connection monitor: Fixing connection status"),this.isConnected=!0,this.setStatus("online"),this.validateInput())},5e3)}subscribeToChannel(){if(!this.pusher)return void console.error("âŒ Cannot subscribe: Pusher not initialized");const e=`private-chat-${this.sessionId}`;console.log("ğŸ“¡ Subscribing to channel:",e);try{this.channel=this.pusher.subscribe(e),this.channel.bind("pusher:subscription_succeeded",()=>{console.log("âœ… Channel subscription succeeded"),console.log("ğŸ”— Channel:",this.channel),this.isConnected=!0,this.validateInput()}),this.channel.bind("pusher:subscription_error",e=>{console.error("âŒ Channel subscription error:",e),console.error("Error details:",e),this.isConnected=!0,this.validateInput();let t="Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ú†Øª";403===e.status?t="Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ø§Ù†Ø§Ù„":404===e.status&&(t="Ú©Ø§Ù†Ø§Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯"),this.showError(t)}),this.channel.bind("client-message",e=>{console.log("ğŸ“¨ New message received:",e),this.handleIncomingMessage(e)})}catch(e){console.error("âŒ Channel subscription error:",e),this.isConnected=!1,this.validateInput()}}setStatus(e){const t={connecting:{text:"Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...",class:"connecting"},online:{text:"Ø¢Ù†Ù„Ø§ÛŒÙ†",class:"online"},offline:{text:"Ø¢ÙÙ„Ø§ÛŒÙ†",class:"offline"}},s=t[e]||t.offline;this.statusDot&&(this.statusDot.className=`status-dot ${s.class}`),this.statusText&&(this.statusText.textContent=s.text)}openChat(){try{if(console.log("ğŸ¯ openChat() called"),console.log("ğŸ“¦ Container state:",{container:this.container,classList:this.container?this.container.classList:"no container"}),!this.container)return void console.error("âŒ Container is null in openChat!");this.container.classList.remove("wp-live-chat-hidden"),this.isOpen=!0,this.unreadCount=0,this.updateNotificationBadge(),console.log("âœ… Chat opened successfully"),console.log("ğŸ“Š Current state:",{isOpen:this.isOpen,userInfoSubmitted:this.userInfoSubmitted,infoFormShown:this.infoFormShown}),this.userInfoSubmitted||this.infoFormShown?(console.log("ğŸ’¬ Showing chat interface"),this.showChatInterface()):(console.log("ğŸ“ Showing user info form"),this.showUserInfoForm())}catch(e){console.error("âŒ Error in openChat:",e),this.showGlobalError("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú†Øª: "+e.message)}}showUserInfoForm(){console.log("ğŸ“ Showing user info form"),this.hideChatInterface();const e=this.container.querySelector("#user-info-form");e&&(e.style.display="block",this.infoFormShown=!0),this.setupInfoForm()}showChatInterface(){console.log("ğŸ’¬ Showing chat interface");const e=this.container.querySelector("#user-info-form");e&&(e.style.display="none");const t=this.container.querySelector(".chat-input-area");t&&(t.style.display="block"),this.userInfoSubmitted&&!this.messageHistoryLoaded?this.loadMessageHistory():this.scrollToBottom(),this.textarea&&setTimeout(()=>{this.textarea.focus()},300)}hideChatInterface(){const e=this.container.querySelector(".chat-input-area");e&&(e.style.display="none")}setupInfoForm(){const e=this.container.querySelector("#contact-info-form");if(!e)return;e.addEventListener("submit",e=>{e.preventDefault(),this.submitUserInfo()});const t=e.querySelector("#user-phone"),s=e.querySelector("#user-name");t&&t.addEventListener("input",()=>{this.validatePhone(t.value)}),s&&s.addEventListener("input",()=>{this.validateName(s.value)})}validatePhone(e){const t=document.getElementById("phone-error");return e?/^09[0-9]{9}$/.test(e)?(this.hideError(t),!0):(this.showError(t,this.config.strings.invalidPhone),!1):(this.showError(t,this.config.strings.phoneRequired),!1)}validateName(e){const t=document.getElementById("name-error");return!e||e.trim().length<2?(this.showError(t,this.config.strings.nameRequired),!1):(this.hideError(t),!0)}showError(e,t){e&&(e.textContent=t,e.style.display="block")}hideError(e){e&&(e.textContent="",e.style.display="none")}async submitUserInfo(){const t=this.container.querySelector("#contact-info-form");if(!t)return;const s=new FormData(t),n=s.get("phone"),o=s.get("name"),i=s.get("company");if(!this.validatePhone(n)||!this.validateName(o))return;const a=t.querySelector(".submit-btn");a&&(a.disabled=!0,a.textContent="Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...");try{const t=await e.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"save_user_info",nonce:this.config.nonce,phone:n,name:o,company:i,session_id:this.sessionId},dataType:"json",contentType:"application/x-www-form-urlencoded; charset=UTF-8",beforeSend:function(e){e.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")}});t.success?(console.log("âœ… User info saved successfully"),this.userInfoSubmitted=!0,this.config.currentUser=t.data.user_data,this.showChatInterface(),this.displayWelcomeMessage(o)):(console.error("âŒ Failed to save user info:",t.data),alert("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª: "+t.data))}catch(e){console.error("âŒ Error saving user info:",e),alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±")}finally{a&&(a.disabled=!1,a.textContent="Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ")}}displayWelcomeMessage(e){const t=`\n                <div class="system-message">\n                    <div class="message-content">\n                        <p>Ø³Ù„Ø§Ù… <strong>${this.escapeHtml(e)}</strong>! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ú†Ú¯ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ú©Ù…Ú© Ú©Ù†Ù…ØŸ</p>\n                    </div>\n                </div>\n            `;this.messagesContainer&&(this.messagesContainer.insertAdjacentHTML("beforeend",t),this.scrollToBottom())}closeChat(){console.log("Closing chat..."),this.container.classList.add("wp-live-chat-hidden"),this.isOpen=!1,console.log("âœ… Chat closed")}updateCharCounter(){if(!this.charCounter||!this.textarea)return;const e=this.textarea.value.length;this.charCounter.textContent=`${e}/500`,this.charCounter.classList.remove("near-limit","exceeded"),e>400&&this.charCounter.classList.add("near-limit"),e>500&&this.charCounter.classList.add("exceeded")}validateInput(){if(!this.textarea||!this.sendButton)return!1;const e=this.textarea.value.trim(),t=e.length>0&&e.length<=500;return this.sendButton.disabled=!t,t?(this.sendButton.style.background="#007cba",this.sendButton.style.cursor="pointer"):(this.sendButton.style.background="#ccc",this.sendButton.style.cursor="not-allowed"),console.log("Validation:",{messageLength:e.length,isValid:t,isConnected:this.isConnected}),t}async sendMessage(){if(!this.userInfoSubmitted)return void this.showUserInfoForm();if(!this.textarea)return;const t=this.textarea.value.trim();if(this.validateInput()){this.messageCount++,console.log("Sending message:",t),this.sendButton&&(this.sendButton.disabled=!0,this.sendButton.textContent="Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...");try{const s="temp_"+Date.now();this.displayMessage({id:s,message:t,user_id:this.currentUser.id,user_name:this.currentUser.name,timestamp:(new Date).toISOString(),type:"user",isTemp:!0}),this.textarea.value="",this.updateCharCounter(),this.validateInput(),console.log("âœ… Message displayed locally"),this.channel&&this.isConnected&&(this.channel.trigger("client-message",{id:s,message:t,user_id:this.currentUser.id,user_name:this.currentUser.name,session_id:this.sessionId,timestamp:(new Date).toISOString(),type:"user",isTemp:!0}),console.log("âœ… Message sent via Pusher"));try{const n=await e.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"send_chat_message",nonce:this.config.nonce,message:t,user_id:this.currentUser.id,user_name:this.currentUser.name,session_id:this.sessionId},dataType:"json",timeout:5e3});n.success&&(console.log("âœ… Message saved to database"),this.replaceTempMessage(s,n.data.message_id))}catch(e){console.warn("âš ï¸ Database save failed:",e),this.markMessageAsPermanent(s)}}catch(e){console.error("âŒ Send message error:",e),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…")}finally{this.sendButton&&(this.sendButton.disabled=!1,this.sendButton.textContent=this.config.strings.send,this.validateInput())}}else console.log("Message validation failed")}replaceTempMessage(e,t){const s=this.messagesContainer.querySelector(`[data-message-id="${e}"]`);s&&(s.dataset.messageId=t,s.classList.remove("temp-message"),console.log("âœ… Temp message replaced with real ID:",t))}markMessageAsPermanent(e){const t=this.messagesContainer.querySelector(`[data-message-id="${e}"]`);t&&(t.classList.remove("temp-message"),console.log("âœ… Temp message marked as permanent"))}updateMessageId(e,t){const s=this.messagesContainer.querySelector(`[data-message-id="${e}"]`);s&&(s.dataset.messageId=t)}displayMessage(e,t=!0){if(!this.messagesContainer)return;const s=this.createMessageElement(e);this.messagesContainer.appendChild(s),t&&this.scrollToBottom()}createMessageElement(e){const t=document.createElement("div");t.className=`message ${e.type}-message`,e.isTemp&&t.classList.add("temp-message"),t.dataset.messageId=e.id;const s=new Date(e.timestamp).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"});let n=e.user_name;return"admin"===e.type?n="Ù¾Ø´ØªÛŒØ¨Ø§Ù†":n&&"undefined"!==n||(n="Ú©Ø§Ø±Ø¨Ø±"),t.innerHTML=`\n                <div class="message-header">\n                    <span class="message-sender">${this.escapeHtml(n)}</span>\n                    <span class="message-time">${s}</span>\n                </div>\n                <div class="message-content">\n                    <p>${this.escapeHtml(e.message)}</p>\n                </div>\n                ${"user"===e.type?'<div class="message-status delivered">âœ“âœ“</div>':""}\n            `,t}handleIncomingMessage(e){"user"===e.type&&e.isTemp?console.log("ğŸ“¨ Ignoring duplicate user message:",e.id):(this.displayMessage(e),this.isOpen||(this.unreadCount++,this.updateNotificationBadge(),this.showDesktopNotification(e)))}showTypingIndicator(e){console.log("User is typing:",e)}updateNotificationBadge(){if(!this.toggle)return;const e=this.toggle.querySelector(".notification-badge");e&&(this.unreadCount>0?(e.textContent=this.unreadCount>9?"9+":this.unreadCount,e.style.display="flex"):(e.textContent="",e.style.display="none"))}scrollToBottom(){this.messagesContainer&&(this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight)}async loadMessageHistory(){console.log("ğŸ“š Loading message history for session:",this.sessionId);try{const t=await e.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"get_chat_history",nonce:this.config.nonce,session_id:this.sessionId},dataType:"json",timeout:1e4});console.log("ğŸ“š History API Response:",t),t.success&&t.data&&Array.isArray(t.data)?(console.log("ğŸ“œ Raw messages data:",t.data),this.renderMessageHistory(t.data),this.messageHistoryLoaded=!0,console.log("âœ… Message history loaded:",t.data.length)):(console.warn("âš ï¸ No message history found or invalid data"),this.messageHistoryLoaded=!0)}catch(e){console.error("âŒ Error loading message history:",e),this.messageHistoryLoaded=!0}}renderMessageHistory(e){if(!this.messagesContainer||!e||0===e.length)return;console.log("ğŸ¨ Rendering message history:",e.length);const t=this.messagesContainer.querySelector(".welcome-message");t&&t.remove(),e.forEach(e=>{this.displayMessage({id:e.id,message:e.message_content,user_id:e.user_id,user_name:e.user_name,timestamp:e.created_at,type:e.message_type},!1)}),this.scrollToBottom()}showError(e){if(!this.messagesContainer)return;const t=document.createElement("div");t.className="chat-error",t.innerHTML=`\n                <div class="error-icon">âš ï¸</div>\n                <p class="error-message">${e}</p>\n                <button class="retry-button">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button>\n            `,t.querySelector(".retry-button").addEventListener("click",()=>{t.remove(),this.initPusher()}),this.messagesContainer.appendChild(t)}showDesktopNotification(e){"Notification"in window&&"granted"===Notification.permission&&new Notification("Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯",{body:`${e.user_name}: ${e.message}`,icon:"/wp-content/plugins/wp-live-chat/assets/images/icon.png"})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}enableManually(){console.log("ğŸ”„ Manually enabling chat..."),this.isConnected=!0,this.setStatus("online"),this.validateInput(),console.log("âœ… Chat manually enabled")}destroy(){this.pusher&&this.pusher.disconnect(),console.log("âœ… Chat destroyed")}}document.addEventListener("DOMContentLoaded",function(){document.getElementById("wp-live-chat-container")&&(window.wpLiveChatInstance=new t,console.log("ğŸ‰ WP Live Chat started successfully!")),document.querySelectorAll(".wp-live-chat-button").forEach(e=>{e.addEventListener("click",function(){window.wpLiveChatInstance&&window.wpLiveChatInstance.openChat()})})}),window.WPLiveChat=t}(jQuery);