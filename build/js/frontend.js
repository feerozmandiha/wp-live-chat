!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.frontend=t():e.frontend=t()}(self,()=>(function(e,t){"use strict";const s=t.console&&t.console.log?t.console.log.bind(console):function(){};class n{constructor(e){this.config=e||t.wpLiveChatFrontend||{},this.ajaxurl=this.config.ajaxurl||"/wp-admin/admin-ajax.php",this.nonce=this.config.nonce||"",this.pusherKey=this.config.pusherKey||"",this.pusherCluster=this.config.pusherCluster||"mt1",this.sessionId=this.config.sessionId||null,this.pusher=null,this.pusherChannel=null,this.pusherPresence=null,this.connected=!1,this.retryCount=0,this.maxRetries=6,this.pollingInterval=null,this.isPolling=!1,this.pollIntervalMs=1e4,this.messageQueue=new Set,this.lastMessageId=null,this.pingInterval=null,this.maxMessageQueueSize=1e3,this.adminOnline=!1,this.unreadCount=0,this.selectors={messagesContainer:"#wlchat-messages",inputSelector:"#wlchat-input",sendButton:"#wlchat-send",statusIndicator:"#wlchat-status",unreadBadge:"#wlchat-unread-badge"},this.init()}init(){this.bindUI(),this.initPusher()}bindUI(){const t=this;e(document).on("click",this.selectors.sendButton,function(e){e.preventDefault(),t.sendMessage()}),e(document).on("keydown",this.selectors.inputSelector,function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),t.sendMessage())}),e(document).on("click",this.selectors.unreadBadge,function(){t.markAllMessagesRead()})}initPusher(){if(!this.pusherKey||"undefined"==typeof Pusher)return s("Pusher unavailable - switching to polling fallback."),void this.initPollingFallback();if(this.pusher)try{this.cleanupPusher()}catch(e){console.warn(e)}try{this.pusher=new Pusher(this.pusherKey,{cluster:this.pusherCluster,forceTLS:!0,authEndpoint:this.ajaxurl,auth:{params:{action:"pusher_auth",nonce:this.nonce,session_id:this.sessionId}},activityTimeout:12e4,pongTimeout:3e4,disableStats:!0});const e=this.sessionId?`private-chat-${this.sessionId}`:null;e&&(this.pusherChannel=this.pusher.subscribe(e),this.pusherChannel.bind("new-message",e=>this.onIncomingMessage(e)),this.pusherChannel.bind("message-read",e=>this.onMessageReadEvent(e)),this.pusherChannel.bind("pusher:subscription_error",e=>{console.error("Subscription error (channel):",e),this.initPollingFallback()}));try{this.pusherPresence=this.pusher.subscribe("presence-chat"),this.pusherPresence.bind("pusher:subscription_succeeded",e=>{this.updateAdminPresence(e)})}catch(e){}this.pusher.connection.bind("state_change",e=>{s("Pusher state change:",e.current),"connected"===e.current?this.onConnected():"disconnected"===e.current||"failed"===e.current?this.onDisconnected():"unavailable"===e.current&&this.initPollingFallback()}),this.pusher.connection.bind("error",e=>{console.error("Pusher connection error:",e),e&&(e.error||e.type)&&this.attemptReconnect()})}catch(e){console.error("Error initializing Pusher:",e),this.initPollingFallback()}}onConnected(){this.connected=!0,this.retryCount=0,this.setConnectedStatus("online"),this.startPing(),this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null,this.isPolling=!1),this.fetchRecentMessages()}onDisconnected(){this.connected=!1,this.setConnectedStatus("offline"),this.attemptReconnect()}attemptReconnect(){if(this.retryCount>=this.maxRetries)return console.warn("Max reconnect attempts reached. Switching to polling fallback."),void this.initPollingFallback();this.retryCount++;const e=Math.min(1e3*Math.pow(2,this.retryCount),3e4);s(`Reconnect attempt #${this.retryCount} in ${e}ms`),setTimeout(()=>{try{this.initPusher()}catch(e){console.warn("Reconnect initPusher failed",e),this.initPollingFallback()}},e)}startPing(){this.pingInterval&&clearInterval(this.pingInterval);try{this.pingInterval=setInterval(()=>{try{if(this.pusher&&this.pusherChannel&&"connected"===this.pusher.connection.state)try{this.pusherChannel.trigger("client-ping",{session_id:this.sessionId,ts:Date.now()})}catch(e){}}catch(e){console.warn("Ping error",e)}},45e3)}catch(e){console.warn(e)}}initPollingFallback(){this.cleanupPusher(),this.setConnectedStatus("offline"),this.showAlert(this._t("chat_fallback_polling","ارتباط لحظه‌ای قطع شد — حالت پس‌زمینه فعال شد"),"warning",6e3),this.pollingInterval&&clearInterval(this.pollingInterval),this.pollingInterval=setInterval(()=>{this.isPolling||this.pollForNewMessages()},this.pollIntervalMs),this.pollForNewMessages()}pollForNewMessages(){if(this.isPolling)return;this.isPolling=!0;const t=this;e.ajax({url:this.ajaxurl,type:"POST",dataType:"json",data:{action:"wp_live_chat_poll_messages",nonce:this.nonce,session_id:this.sessionId,last_message_id:this.lastMessageId},timeout:1e4}).done(function(e){if(e&&e.success&&e.data&&Array.isArray(e.data.messages)){const s=e.data.messages;if(s.forEach(e=>t.onIncomingMessage(e)),s.length){const e=s[s.length-1];t.lastMessageId=e.id||t.lastMessageId}}}).fail(function(e){console.error("Polling error",e)}).always(function(){t.isPolling=!1})}fetchRecentMessages(){const t=this;e.ajax({url:this.ajaxurl,type:"POST",dataType:"json",data:{action:"wp_live_chat_get_messages",nonce:this.nonce,session_id:this.sessionId,since_id:this.lastMessageId},timeout:1e4}).done(function(e){if(e&&e.success&&Array.isArray(e.data)&&(e.data.forEach(e=>t.onIncomingMessage(e)),e.data.length)){const s=e.data[e.data.length-1];t.lastMessageId=s.id||t.lastMessageId}}).fail(function(e){console.warn("fetchRecentMessages failed",e)})}onIncomingMessage(e){if(!e)return;const t=e.message||e.message_content||e.text||"";if(!t||"string"!=typeof t)return;const s=e.id||e.message_id||this.generateMessageId(t,e.created_at||e.timestamp);if(this.messageQueue.has(s))return;if(this.messageQueue.add(s),this.messageQueue.size>this.maxMessageQueueSize){const e=this.messageQueue.values().next().value;this.messageQueue.delete(e)}const n={id:s,text:t,user_name:e.user_name||e.sender_name||this._t("user","کاربر"),created_at:e.created_at||e.timestamp||(new Date).toISOString(),type:e.type||("admin"===e.from?"admin":"user")};this.appendMessage(n),(e.id||e.message_id)&&(this.lastMessageId=e.id||e.message_id),this.adminOnline||(this.unreadCount++,this.updateUnreadBadge())}appendMessage(t){try{const s=e(this.selectors.messagesContainer);if(0===s.length)return;const n="admin"===t.type?"wlchat-admin":"wlchat-user",i=this.formatTime(t.created_at),a=`<div class="wlchat-message ${n}" data-wlchat-id="${this.escapeHtml(t.id)}">\n                        <div class="wlchat-message-header">\n                          <span class="wlchat-name">${this.escapeHtml(t.user_name)}</span>\n                          <span class="wlchat-time">${this.escapeHtml(i)}</span>\n                        </div>\n                        <div class="wlchat-message-body">${this.escapeHtml(t.text)}</div>\n                      </div>`;s.append(a),s.stop().animate({scrollTop:s[0].scrollHeight},250)}catch(e){console.warn("appendMessage error",e)}}sendMessage(){const t=e(this.selectors.inputSelector);if(0===t.length)return;const s=t.val();if(!s||!s.trim())return;const n={action:"wp_live_chat_send_message",nonce:this.nonce,session_id:this.sessionId,message:s},i=e(this.selectors.sendButton);i.prop("disabled",!0).addClass("sending"),e.ajax({url:this.ajaxurl,type:"POST",dataType:"json",data:n,timeout:1e4}).done(e=>{if(e&&e.success){t.val("");const n={id:e.data&&e.data.id?e.data.id:this.generateMessageId(s,Date.now()),text:s,user_name:this._t("you","شما"),created_at:(new Date).toISOString(),type:"admin"};this.onIncomingMessage({id:n.id,message:n.text,user_name:n.user_name,created_at:n.created_at,type:"admin"})}else this.showAlert(this._t("send_failed","ارسال پیام با خطا مواجه شد"),"error",4e3)}).fail(e=>{console.error("sendMessage ajax error",e),this.showAlert(this._t("send_failed","ارسال پیام با خطا مواجه شد"),"error",4e3)}).always(()=>{i.prop("disabled",!1).removeClass("sending")})}markAllMessagesRead(){e.ajax({url:this.ajaxurl,type:"POST",dataType:"json",data:{action:"wp_live_chat_mark_read",nonce:this.nonce,session_id:this.sessionId},timeout:8e3}).done(e=>{e&&e.success&&(this.unreadCount=0,this.updateUnreadBadge())}).fail(e=>{console.warn("markAllMessagesRead failed",e)})}onMessageReadEvent(t){t&&(t.message_id&&e(`[data-wlchat-id="${this.escapeHtml(t.message_id)}"]`).addClass("wlchat-read"),t.session_read&&(this.unreadCount=0,this.updateUnreadBadge()))}updateAdminPresence(e){}updateUnreadBadge(){const t=e(this.selectors.unreadBadge);0!==t.length&&(this.unreadCount>0?t.text(this.unreadCount).show():t.hide().text(""))}markMessageRead(t){t&&e.post(this.ajaxurl,{action:"wp_live_chat_mark_message_read",nonce:this.nonce,message_id:t}).done(s=>{e(`[data-wlchat-id="${this.escapeHtml(t)}"]`).addClass("wlchat-read")}).fail(e=>{console.warn("markMessageRead failed",e)})}cleanupPusher(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null,this.isPolling=!1);try{if(this.pusher){try{this.pusherChannel&&(this.pusher.unsubscribe(this.pusherChannel.name||`private-chat-${this.sessionId}`),this.pusherChannel=null)}catch(e){}try{this.pusherPresence&&(this.pusher.unsubscribe("presence-chat"),this.pusherPresence=null)}catch(e){}try{this.pusher.disconnect()}catch(e){}}}catch(e){console.warn("cleanupPusher error",e)}finally{this.pusher=null,this.connected=!1}}generateMessageId(e,t){let s=`${e}-${t?"number"==typeof t?t:Date.parse(t)||Date.now():Date.now()}`,n=5381;for(let e=0;e<s.length;e++)n=(n<<5)+n+s.charCodeAt(e);return"wlm-"+(n>>>0).toString(36)}setConnectedStatus(t){const s=e(this.selectors.statusIndicator);0!==s.length&&(s.removeClass("status-online status-offline status-warning"),"online"===t?s.addClass("status-online").text(this._t("online","آنلاین")):"offline"===t?s.addClass("status-offline").text(this._t("offline","آفلاین")):s.addClass("status-warning").text(t))}showAlert(t,s="info",n=4e3){const i="wlchat-toast-"+Date.now(),a=e(`<div id="${i}" class="wlchat-toast wlchat-toast-${s}">${this.escapeHtml(t)}</div>`);e("body").append(a),a.hide().fadeIn(200),setTimeout(()=>a.fadeOut(200,()=>a.remove()),n)}formatTime(e){if(!e)return"";try{const t=new Date(e);return isNaN(t.getTime())?e:t.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit",hour12:!1})}catch(t){return e}}_t(e,t){return this.config.strings&&void 0!==this.config.strings[e]?this.config.strings[e]:t||e}escapeHtml(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}}e(function(){try{const e=t.wpLiveChatFrontend||null;if(!e)return void s("wpLiveChatFrontend config not found. frontend.js not initialized.");t.wpLiveChatFrontendApp=new n(e),s("WPLiveChatFrontend initialized")}catch(e){console.error("Failed to initialize WPLiveChatFrontend:",e)}})}(jQuery,window),{}));