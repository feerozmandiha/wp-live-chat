!function(s){if("undefined"==typeof wpLiveChatAdmin)return;const e=wpLiveChatAdmin.ajaxurl,n=wpLiveChatAdmin.nonce,t=window.wpLiveChat&&window.wpLiveChat.pusherKey,i=window.wpLiveChat&&window.wpLiveChat.pusherCluster;let c=null,o=null,a=null;function l(){s("#wlch-sessions-list").text("در حال بارگذاری..."),s.post(e,{action:"wp_live_chat_get_sessions",nonce:n},function(t){if(!t.success)return void s("#wlch-sessions-list").text("خطا در بارگذاری جلسات");const i=t.data;if(!i.length)return void s("#wlch-sessions-list").html("<div>جلسه‌ای یافت نشد</div>");const l=s("<ul/>");i.forEach(function(t){const i=s('<li class="wlch-session-item" data-session="'+t.session_id+'"></li>');i.text((t.user_name||"کاربر")+" — "+(t.user_phone||"")+" — "+t.last_activity),i.on("click",function(){!function(t){if(c=t,s("#wlch-chat-header").text("گفتگو: "+t),s("#wlch-messages").html("<div>در حال بارگذاری پیام‌ها...</div>"),o&&a){try{o.unsubscribe("chat-"+a.sessionId)}catch(s){}a=null}o&&(a=o.subscribe("chat-"+t),a.bind("new-message",function(e){s("#wlch-messages").append(`<div class="wlch-msg"><strong>${h(e.user_name)}:</strong> ${h(e.message)}</div>`),s("#wlch-messages").scrollTop(s("#wlch-messages")[0].scrollHeight)}),a.sessionId=t),s.post(e,{action:"wp_live_chat_get_messages",nonce:n,session_id:t},function(e){e.success?(s("#wlch-messages").empty(),e.data.forEach(function(e){s("#wlch-messages").append(`<div class="wlch-msg"><strong>${h(e.user_name)}:</strong> ${h(e.message_content)}</div>`)}),s("#wlch-messages").scrollTop(s("#wlch-messages")[0].scrollHeight)):s("#wlch-messages").text("خطا در بارگذاری پیام‌ها")})}(t.session_id)}),l.append(i)}),s("#wlch-sessions-list").empty().append(l)})}function h(e){return s("<div/>").text(e).html()}s(document).on("click","#wlch-send-btn",function(){const t=s("#wlch-admin-message").val().trim();if(!c)return alert("یک جلسه انتخاب کنید");t&&s.post(e,{action:"wp_live_chat_admin_send",nonce:n,session_id:c,message:t},function(e){if(!e.success)return alert("خطا در ارسال");s("#wlch-admin-message").val("")})}),s(function(){l(),function(){if(t)try{o=new Pusher(t,{cluster:i}),o.subscribe("admin-chat-channel").bind("message-sent",function(s){l()})}catch(s){console&&console.warn&&console.warn("Pusher admin init error",s)}}()})}(jQuery);