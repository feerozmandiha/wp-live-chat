!function(s){"use strict";class e{constructor(){this.config=window.wpLiveChatAdmin||{},this.pusher=null,this.currentSession=null,this.sessions=[],this.currentChannel=null,console.log("ğŸš€ Admin Chat Initializing...",this.config),this.init()}async init(){this.bindEvents(),await this.loadSessions(),this.initPusher(),this.requestNotificationPermission()}requestNotificationPermission(){"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission().then(s=>{console.log("Notification permission:",s)}).catch(s=>{console.error("Error requesting notification permission:",s)})}bindEvents(){s("#reload-sessions").on("click",()=>this.loadSessions()),s("#admin-send-button").on("click",()=>this.sendMessage()),s("#admin-message-input").on("keydown",s=>{"Enter"!==s.key||s.shiftKey||(s.preventDefault(),this.sendMessage())})}loadSessions(){return console.log("ğŸ“‹ Loading sessions..."),new Promise((e,n)=>{s.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"get_chat_sessions",nonce:this.config.nonce},dataType:"json",timeout:1e4}).done(s=>{console.log("ğŸ“¡ API Response:",s),s.success?(this.sessions=s.data,this.renderSessions(),console.log("âœ… Sessions loaded:",this.sessions.length),e(s.data)):(console.error("âŒ API Error:",s.data),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§: "+(s.data||"Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡")),n(s.data))}).fail(s=>{if(console.error("âŒ Network Error:",s),s.responseText&&s.responseText.includes("wpdberror"))this.showError("Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ - Ù„Ø·ÙØ§ Ø¬Ø¯Ø§ÙˆÙ„ Ú†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯"),console.error("ğŸ“‹ Database error in response:",s.responseText);else{let e="Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±";500===s.status?e="Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ± (500) - Ù„Ø·ÙØ§ error_log Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯":403===s.status?e="Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²":s.statusText&&(e+=": "+s.statusText),this.showError(e)}n(s)})})}renderSessions(){const e=s("#sessions-container");e.empty(),0!==this.sessions.length?this.sessions.forEach(n=>{const i=n.last_message||{};let t=n.user_name||"Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³";"undefined"!==t&&"Ù…Ù‡Ù…Ø§Ù†"!==t||(t="Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†");const o=s(`\n                    <div class="session-item" data-session-id="${n.session_id}">\n                        <div class="session-user">\n                            <strong>${this.escapeHtml(t)}</strong>\n                            ${n.user_email?`<br><small>${n.user_email}</small>`:""}\n                            ${i.message_content?`<br><small class="last-message">${this.truncateText(i.message_content,30)}</small>`:""}\n                        </div>\n                        <div class="session-info">\n                            <small>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: ${n.message_count||0}</small>\n                            <br>\n                            <small>Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: ${this.formatTime(n.last_activity)}</small>\n                        </div>\n                        <div class="session-status">\n                            <span class="status-dot ${"active"===n.status?"online":"offline"}"></span>\n                            ${n.unread_count>0?`<span class="unread-badge">${n.unread_count}</span>`:""}\n                        </div>\n                    </div>\n                `);o.on("click",()=>this.selectSession(n)),e.append(o)}):e.html('<div class="no-sessions">Ù‡ÛŒÚ† Ú¯ÙØªÚ¯ÙˆÛŒ ÙØ¹Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>')}async selectSession(e){console.log("ğŸ¯ Selecting session:",e),s(".session-item").removeClass("active"),s(`.session-item[data-session-id="${e.session_id}"]`).addClass("active"),this.currentSession=e,s("#current-session-name").text(e.user_name||"Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³"),s("#session-status").text("active"===e.status?"Ø¢Ù†Ù„Ø§ÛŒÙ†":"Ø¢ÙÙ„Ø§ÛŒÙ†").removeClass("status-offline status-online").addClass("active"===e.status?"status-online":"status-offline"),s("#admin-message-input").prop("disabled",!1),s("#admin-send-button").prop("disabled",!1),await this.loadSessionMessages(e.session_id),this.subscribeToSession(e.session_id)}loadSessionMessages(e){return console.log("ğŸ“¨ Loading messages for session:",e),new Promise((n,i)=>{s.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"get_session_messages",nonce:this.config.nonce,session_id:e},dataType:"json",timeout:1e4}).done(s=>{console.log("ğŸ“¨ Messages API Response:",s),s.success?(this.renderMessages(s.data),console.log("âœ… Messages loaded:",s.data.length),n(s.data)):(console.error("âŒ API Error:",s.data),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: "+s.data),i(s.data))}).fail(s=>{console.error("âŒ Network Error:",s),s.responseText&&s.responseText.includes("wpdberror")?this.showError("Ø®Ø·Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§"):this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: "+s.statusText),i(s)})})}renderMessages(e){const n=s("#admin-chat-messages");n.empty(),s(".no-chat-selected").remove(),e&&0!==e.length?(e.forEach(e=>{const i="admin"===e.message_type?"message-admin-user":"message-user",t="admin"===e.message_type?"Ù¾Ø´ØªÛŒØ¨Ø§Ù†":e.user_name||"Ú©Ø§Ø±Ø¨Ø±",o=s(`\n                    <div class="message-admin ${i}">\n                        <div class="message-content">\n                            <p>${this.escapeHtml(e.message_content)}</p>\n                        </div>\n                        <div class="message-time">\n                            ${this.formatTime(e.created_at)}\n                            <span class="sender-name">(${t})</span>\n                        </div>\n                    </div>\n                `);n.append(o)}),n.scrollTop(n[0].scrollHeight)):n.html('<div class="no-messages">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ø±Ø¯ Ùˆ Ø¨Ø¯Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>')}async sendMessage(){const e=s("#admin-message-input"),n=e.val().trim();if(n&&this.currentSession){console.log("ğŸ“¤ Sending admin message:",n),s("#admin-send-button").prop("disabled",!0).text("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...");try{const i=await s.ajax({url:this.config.ajaxurl,type:"POST",data:{action:"send_admin_message",nonce:this.config.nonce,message:n,session_id:this.currentSession.session_id},dataType:"json",timeout:1e4});console.log("ğŸ“¤ Send Message Response:",i),i.success?(console.log("âœ… Admin message sent"),e.val(""),await this.loadSessionMessages(this.currentSession.session_id)):(console.error("âŒ Failed to send admin message:",i.data),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: "+i.data))}catch(s){console.error("âŒ Error sending message:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: "+s.statusText)}finally{s("#admin-send-button").prop("disabled",!1).text("Ø§Ø±Ø³Ø§Ù„")}}}addLocalMessage(e){const n=s("#admin-chat-messages"),i="admin"===e.message_type?"message-admin-user":"message-user",t="admin"===e.message_type?"Ù¾Ø´ØªÛŒØ¨Ø§Ù†":e.user_name||"Ú©Ø§Ø±Ø¨Ø±",o=s(`\n                <div class="message-admin ${i}">\n                    <div class="message-content">\n                        <p>${this.escapeHtml(e.message_content)}</p>\n                    </div>\n                    <div class="message-time">\n                        ${this.formatTime(e.created_at)}\n                        <span class="sender-name">(${t})</span>\n                    </div>\n                </div>\n            `);n.append(o),n.scrollTop(n[0].scrollHeight)}checkInternetConnection(){return!!navigator.onLine||(this.showError("Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª"),!1)}initPusher(){if(!this.config.pusherKey)return console.warn("âš ï¸ Pusher key not configured"),void this.showError("Ú©Ù„ÛŒØ¯ Pusher ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª");if("undefined"==typeof Pusher)return console.error("âŒ Pusher library not loaded"),void this.showError("Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Pusher Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯");try{this.pusher=new Pusher(this.config.pusherKey,{cluster:this.config.pusherCluster,forceTLS:!0,authEndpoint:this.config.ajaxurl,auth:{params:{action:"auth_pusher_channel_admin",nonce:this.config.nonce}},enabledTransports:["ws","wss","xhr_streaming","xhr_polling"],disabledTransports:["sockjs"]}),console.log("âœ… Pusher initialized for admin"),this.pusher.connection.bind("state_change",s=>{console.log("ğŸ”Œ Admin Pusher State:",s.previous,"->",s.current)}),this.pusher.connection.bind("connected",()=>{console.log("âœ… Pusher connected successfully")}),this.pusher.connection.bind("error",s=>{console.error("âŒ Pusher connection error:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Pusher: "+s.message)})}catch(s){console.error("âŒ Pusher init error:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Pusher: "+s.message),this.showError("Ø§ØªØµØ§Ù„ real-time ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯. Ú†Øª Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø§Ø¯ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.")}this.adminChannel=this.pusher.subscribe("admin-chat-channel"),this.adminChannel.bind("new-user-message",s=>{console.log("ğŸ”” New user message received:",s),this.currentSession&&this.currentSession.session_id===s.session_id&&this.loadSessionMessages(s.session_id),this.receivedMessageIds=new Set,this.loadSessions(),this.showNewMessageNotification(s)})}handleNewMessage(s){console.log("ğŸ“¨ New message in admin:",s),this.isMessageDuplicate(s.message_id)?console.log("âš ï¸ Duplicate message in admin, ignoring:",s.message_id):(this.currentSession&&this.currentSession.session_id===s.session_id&&(console.log("ğŸ”„ Refreshing messages for current session"),this.loadSessionMessages(s.session_id)),this.loadSessions())}isMessageDuplicate(s){if(this.receivedMessageIds.has(s))return!0;if(this.receivedMessageIds.add(s),this.receivedMessageIds.size>1e3){const s=this.receivedMessageIds.values().next().value;this.receivedMessageIds.delete(s)}return!1}showNewMessageNotification(s){this.currentSession&&this.currentSession.session_id===s.session_id||(new Notification("Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² "+s.user_name,{body:s.message,icon:"/wp-content/plugins/wp-live-chat/assets/images/icon.png"}).onclick=()=>{const e=this.sessions.find(e=>e.session_id===s.session_id);e&&this.selectSession(e)})}subscribeToSession(s){if(!this.pusher)return void console.error("Pusher not initialized");this.currentChannel&&(this.currentChannel.unbind_all(),this.pusher.unsubscribe(this.currentChannel.name));const e=`private-chat-${s}`;try{this.currentChannel=this.pusher.subscribe(e),this.currentChannel.bind("pusher:subscription_succeeded",()=>{console.log("âœ… Admin subscribed to session:",s)}),this.currentChannel.bind("pusher:subscription_error",s=>{console.error("âŒ Subscription error:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ú†Øª")}),this.currentChannel.bind("client-message",e=>{console.log("ğŸ“¨ New message received in admin:",e),this.currentSession&&this.currentSession.session_id===s&&"admin"!==e.type&&this.loadSessionMessages(s),this.loadSessions()})}catch(s){console.error("âŒ Subscription error:",s),this.showError("Ø®Ø·Ø§ Ø¯Ø± Ø¹Ø¶ÙˆÛŒØª Ú©Ø§Ù†Ø§Ù„: "+s.message)}}showError(e){console.error("ğŸ’¥ Error:",e);const n=`\n                <div class="notice notice-error inline" style="margin: 10px 0; padding: 10px;">\n                    <p><strong>Ø®Ø·Ø§:</strong> ${e}</p>\n                </div>\n            `;s(".notice.notice-error").remove(),s(".wrap").prepend(n),setTimeout(()=>{s(".notice.notice-error").fadeOut()},5e3)}formatTime(s){if(!s)return"--:--";try{return new Date(s).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}catch(s){return"--:--"}}truncateText(s,e){return s?s.length<=e?s:s.substring(0,e)+"...":""}escapeHtml(s){if(!s)return"";const e=document.createElement("div");return e.textContent=s,e.innerHTML}}s(document).ready(function(){window.wpLiveChatAdminApp=new e})}(jQuery);