!function(e,s){"use strict";if(void 0!==s){if(void 0!==e.wpLiveChat){class t{constructor(e={}){this.ajaxurl=e.ajaxurl||"/wp-admin/admin-ajax.php",this.nonce=e.nonce||"",this.pusherKey=e.pusherKey||"",this.pusherCluster=e.pusherCluster||"",this.sessionId=e.sessionId||"chat_"+this._uuid(),this.currentUser=e.userData||e.currentUser||{},this.strings=e.strings||{},this.pusher=null,this.isHistoryLoading=!1,this.historyLoaded=!1,this.messageHistory=[],this.selectors={container:"#wp-live-chat-container",messages:".chat-messages",toggle:".chat-toggle",widget:".chat-widget",userForm:".user-info-form",phoneInput:"#wlch-phone",nameInput:"#wlch-name",saveInfoBtn:"#wlch-save-info",skipInfoBtn:"#wlch-skip-info",inputArea:".chat-input-area",textarea:"#wlch-textarea",counter:"#wlch-counter",sendBtn:"#wlch-send-btn",closeBtn:".chat-close",notificationBadge:".notification-badge",typingIndicator:".typing-indicator"},this.maxChars=500,this.connected=!1,this.unreadCount=0,this.isTyping=!1,this.lastMessageId=null,this.messageQueue=new Set,this.isSending=!1,this.init()}init(){this.cacheElements(),this.$container.addClass("position-bottom-left"),this.bindUI(),this.loadHistoryAndScroll(),this.showUserForms(),this.initPusher(),this.updateCounter(),this.setConnectedStatus("connecting")}cacheElements(){this.$container=s(this.selectors.container),this.$messages=this.$container.find(this.selectors.messages),this.$toggle=this.$container.find(this.selectors.toggle),this.$widget=this.$container.find(this.selectors.widget),this.$userForm=this.$container.find(this.selectors.userForm),this.$phoneInput=this.$container.find(this.selectors.phoneInput),this.$nameInput=this.$container.find(this.selectors.nameInput),this.$saveInfoBtn=this.$container.find(this.selectors.saveInfoBtn),this.$skipInfoBtn=this.$container.find(this.selectors.skipInfoBtn),this.$inputArea=this.$container.find(this.selectors.inputArea),this.$textarea=this.$container.find(this.selectors.textarea),this.$counter=this.$container.find(this.selectors.counter),this.$sendBtn=this.$container.find(this.selectors.sendBtn),this.$closeBtn=this.$container.find(this.selectors.closeBtn),this.$notif=this.$container.find(this.selectors.notificationBadge),this.$typingIndicator=this.$container.find(this.selectors.typingIndicator)}openChat(){this.$container.removeClass("wp-live-chat-hidden"),this.unreadCount=0,this.updateNotificationBadge(0),this.historyLoaded||this.isHistoryLoading?setTimeout(()=>{this.scrollToBottom(!0,!0),this.$textarea.focus()},100):(this.isHistoryLoading=!0,this.loadHistoryAndScroll()),this.sendChatOpenedEvent()}closeChat(){this.$container.addClass("wp-live-chat-hidden"),this.sendChatClosedEvent()}sendChatOpenedEvent(){if(this.pusher&&this.connected)try{const e=this.pusher.channel("chat-"+this.sessionId);e&&e.trigger("client-chat-opened",{user_id:this.currentUser.id||0,user_name:this.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±",timestamp:(new Date).toISOString()})}catch(e){console.log("Chat opened event not sent")}}sendChatClosedEvent(){if(this.pusher&&this.connected)try{const e=this.pusher.channel("chat-"+this.sessionId);e&&e.trigger("client-chat-closed",{user_id:this.currentUser.id||0,timestamp:(new Date).toISOString()})}catch(e){console.log("Chat closed event not sent")}}initPusher(){if(!this.pusherKey||"undefined"==typeof Pusher)return this.setConnectedStatus("offline"),void this.showAlert("Ø³Ø±ÙˆÛŒØ³ Ú†Øª Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª","error");try{Pusher.logToConsole=!1,this.pusher=new Pusher(this.pusherKey,{cluster:this.pusherCluster||"mt1",forceTLS:!0});const e="chat-"+this.sessionId,s=this.pusher.subscribe(e);this.pusher.connection.bind("state_change",e=>{console.log("Pusher state:",e.current),"connected"===e.current?(this.setConnectedStatus("online"),this.showAlert("Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯","success",3e3)):"disconnected"!==e.current&&"failed"!==e.current||this.setConnectedStatus("offline")}),s.bind("new-message",e=>{this.onIncomingMessage(e)}),s.bind("admin-typing",()=>{this.showTypingIndicator()}),s.bind("admin-stopped-typing",()=>{this.hideTypingIndicator()}),this.pusher.subscribe("admin-notifications").bind("admin-connected",()=>{this.showAlert("Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯","info",3e3)})}catch(e){console.warn("Pusher init error",e),this.setConnectedStatus("offline"),this.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³ Ú†Øª","error")}}onIncomingMessage(e){if(console.log("Incoming message from Pusher:",e),!e||!e.message&&!e.message_content)return void console.error("Invalid payload:",e);const s=(e.message||e.message_content||"").trim();if(!s)return void console.error("Empty message:",e);const t=e.id||this.generateMessageId(s,e.timestamp);if(this.messageQueue.has(t))return void console.log("Duplicate message ignored (by ID):",t);if(this.isDuplicateMessage(s,e.timestamp))return void console.log("Duplicate message ignored (by content):",s.substring(0,50));const n=this.findOptimisticIdForMessage(s);if(n){console.log("Replacing optimistic message:",n,"with real message:",t);const s=this.$messages.find(`[data-message-id="${n}"]`);s.length?(s.removeClass("sending").addClass("sent"),s.find(".sending-status").text("âœ… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯"),setTimeout(()=>{s.fadeOut(300,()=>{s.remove(),this.messageQueue.delete(n),this.addMessageToChat({...e,id:t})})},1e3)):this.addMessageToChat({...e,id:t})}else this.addMessageToChat({...e,id:t})}generateMessageId(e,s){return`msg_${s?new Date(s).getTime():Date.now()}_${this.hashCode(e)}`}hashCode(e){let s=0;for(let t=0;t<e.length;t++)s=(s<<5)-s+e.charCodeAt(t),s&=s;return Math.abs(s).toString(16).substring(0,8)}isDuplicateMessage(e,t){const n=e.trim();if(!n)return!1;const i=t?new Date(t).getTime():Date.now();for(const e of this.messageHistory)if(e.text===n){const s=new Date(e.timestamp).getTime();if(Math.abs(i-s)<5e3)return!0}const a=this.$messages.find('.message:not([data-message-id^="temp_"])');for(let e=0;e<a.length;e++){const t=s(a[e]);if(t.find(".message-content p").text().trim()===n){const e=t.data("timestamp");if(!e)return!0;{const s=new Date(e).getTime();if(Math.abs(i-s)<5e3)return!0}}}return!1}addMessageToChat(e){e.id&&this.messageQueue.add(e.id),this.$messages.find(".welcome-message").length&&this.$messages.find(".welcome-message").remove(),this.hideTypingIndicator();const s=this._renderMessage(e);return this.messageHistory.push({id:e.id,text:e.message||e.message_content,timestamp:e.timestamp||(new Date).toISOString()}),this.messageHistory.length>50&&this.messageHistory.shift(),this.scrollToBottom(),this.$container.hasClass("wp-live-chat-hidden")&&"admin"===e.type&&(this.unreadCount++,this.updateNotificationBadge(this.unreadCount),"Notification"in window&&"granted"===Notification.permission&&new Notification("Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù†",{body:e.message||e.message_content,icon:"/wp-content/plugins/wp-live-chat/assets/images/icon.png"})),s}findOptimisticIdForMessage(e){const t=e.trim();let n=null;return this.$messages.find('.message[data-message-id^="temp_"]').each(function(){const e=s(this);if(e.find(".message-content p").text().replace("â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...","").replace("âœ… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯","").replace("âœ… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Ø³Ø±ÙˆØ±...)","").trim()===t)return n=e.data("message-id"),!1}),n}appendMessage(e){return!(e.id&&this.messageQueue.has(e.id)||(e.id&&this.messageQueue.add(e.id),this.$messages.find(".welcome-message").length&&this.$messages.find(".welcome-message").remove(),this.hideTypingIndicator(),this._renderMessage(e),this.scrollToBottom(),0))}_renderMessage(e){if(!this.$messages)return null;const t={id:"",message:"",user_name:"Ú©Ø§Ø±Ø¨Ø±",timestamp:(new Date).toISOString(),type:"user",status:"sent",...e},n=this._formatTime(t.timestamp);let i="user-message",a=t.user_name,o="",r="";switch(t.type){case"admin":i="admin-message",a="ğŸ‘¨â€ğŸ’¼ Ù¾Ø´ØªÛŒØ¨Ø§Ù†",r="slide-in-left";break;case"system":i="system-message",a="âš™ï¸ Ø³ÛŒØ³ØªÙ…",r="slide-in-left";break;case"user":a="ğŸ‘¤ "+a,r="slide-in-right"}switch(t.status){case"sending":o='<span class="message-status sending">â³</span>',i+=" sending";break;case"sent":o='<span class="message-status sent">âœ“</span>',i+=" sent";break;case"delivered":o='<span class="message-status delivered">âœ“âœ“</span>';break;case"read":o='<span class="message-status read">ğŸ‘ï¸</span>';break;case"error":o='<span class="message-status error">âŒ</span>',i+=" error"}let c=this._escapeHtml(t.message||t.message_content||"");c=this._addEmojis(c),c=this._autoLink(c);const d=s(`\n        <div class="message ${i} ${r}" data-message-id="${this._escapeAttr(t.id)}" data-timestamp="${this._escapeAttr(t.timestamp)}">\n        <div class="message-header">\n            <div class="message-sender">${a}</div>\n            <div class="message-time">${n} ${o}</div>\n        </div>\n        <div class="message-content">\n            <p>${c}</p>\n        </div>\n        </div>\n    `);return d.hide().appendTo(this.$messages).fadeIn(300),setTimeout(()=>{d.removeClass(r)},300),d}_autoLink(e){return e.replace(/(https?:\/\/[^\s]+)/g,function(e){return'<a href="'+e+'" target="_blank" rel="noopener noreferrer" style="color: #007cba; text-decoration: underline;">'+e+"</a>"})}sendMessage(e){const t=this;if(!e||!e.trim())return;if(this.isSending)return void this.showAlert("Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...","info",2e3);const n=e.trim(),i="temp_"+Date.now()+"_"+this.hashCode(n);if(this.messageQueue.has(i))return void this.showAlert("Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª","info",3e3);this.isSending=!0,this.$sendBtn.prop("disabled",!0).html('<span class="send-icon">â³</span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...');const a={id:i,message:n,user_name:this.currentUser.name||this.currentUser.display_name||"Ø´Ù…Ø§",timestamp:(new Date).toISOString(),type:"user",status:"sending"},o=this._renderMessage(a);this.messageQueue.add(i),this.messageHistory.push({id:i,text:n,timestamp:a.timestamp}),this.$textarea.val(""),this.updateCounter(),this.scrollToBottom(),s.ajax({url:this.ajaxurl,type:"POST",data:{action:"send_chat_message",nonce:this.nonce,session_id:this.sessionId,message:n,user_name:this.currentUser.name||this.currentUser.display_name||"",user_id:this.currentUser.id||0,temp_id:i},dataType:"json",timeout:1e4}).done(function(e){if(e&&e.success){if(t.showAlert("Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯","success",3e3),o&&(o.removeClass("sending").addClass("sent"),o.find(".message-status").text("âœ“").removeClass("sending").addClass("sent"),o.find(".sending-status").remove()),e.data&&e.data.message_id){const s=e.data.message_id;t.messageQueue.delete(i),t.messageQueue.add(s);const n=t.messageHistory.findIndex(e=>e.id===i);-1!==n&&(t.messageHistory[n].id=s),o&&o.attr("data-message-id",s)}}else t.handleSendError(o,i,e?e.data:"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…")}).fail(function(e,s,n){t.handleSendError(o,i,"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±"),console.error("Send message failed:",s,n)}).always(function(){t.isSending=!1,t.$sendBtn.prop("disabled",!1).html('<span class="send-icon">âœ‰ï¸</span> Ø§Ø±Ø³Ø§Ù„')})}handleSendError(e,s,t){e&&(e.addClass("message-error"),e.find(".message-content p").append('<small style="display:block; color:#dc3232; margin-top:5px; font-style:italic;">âš ï¸ '+t+"</small>")),this.messageQueue.delete(s),this.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: "+t,"error",5e3),this.$textarea.focus()}sendTypingEvent(e){if(this.pusher&&this.connected)try{const s=this.pusher.channel("chat-"+this.sessionId);s&&("typing"===e?s.trigger("client-user-typing",{user_id:this.currentUser.id||0,user_name:this.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±"}):"stopped"===e&&s.trigger("client-user-stopped-typing",{user_id:this.currentUser.id||0}))}catch(e){console.log("Typing event not sent (might need client events enabled)")}}showTypingIndicator(){this.$typingIndicator&&(this.$typingIndicator.stop(!0,!0).fadeIn(300),this.scrollToBottom())}hideTypingIndicator(){this.$typingIndicator&&this.$typingIndicator.stop(!0,!0).fadeOut(300)}showUserForms(){if(this.currentUser&&(this.currentUser.phone||this.currentUser.name))return this.showInputArea(!0),this.showUserInfoForm(!1),void this.showAlert("Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ "+(this.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±"),"info",3e3);this.showInputArea(!1),this.showUserInfoForm(!0)}showInputArea(e){this.$inputArea&&(e?(this.$inputArea.slideDown(300),setTimeout(()=>this.$textarea.focus(),350)):this.$inputArea.slideUp(300))}showUserInfoForm(e){this.$userForm&&(e?(this.$userForm.slideDown(400),setTimeout(()=>this.$phoneInput.focus(),450)):this.$userForm.slideUp(300))}loadHistory(){const e=this;this.$messages.html(`\n        <div class="welcome-message">\n          <p>${this._escapeHtml(this.strings.welcome||"Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.")}</p>\n        </div>\n        <div class="loading-history" style="text-align:center; padding:20px; color:#666;">\n          <div class="spinner"></div>\n          <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡...</p>\n        </div>\n      `),s.ajax({url:this.ajaxurl,type:"POST",data:{action:"get_chat_history",nonce:this.nonce,session_id:this.sessionId},dataType:"json",timeout:1e4}).done(function(s){e.$messages.find(".loading-history").remove(),s&&s.success&&Array.isArray(s.data)?0===s.data.length||(e.$messages.find(".welcome-message").remove(),s.data.forEach(function(s){e.messageQueue.has(s.id)||e.appendMessage({id:s.id,message:s.message_content,user_name:s.user_name,timestamp:s.created_at,type:s.message_type})})):e.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡","error")}).fail(function(){e.$messages.find(".loading-history").remove(),e.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡","error")})}bindUI(){const e=this;let t;s(document).on("click",this.selectors.toggle,function(){e.$container.hasClass("wp-live-chat-hidden")?(e.$container.removeClass("wp-live-chat-hidden"),e.unreadCount=0,e.updateNotificationBadge(0),setTimeout(()=>{0===e.messageHistory.length?e.loadHistoryAndScroll():e.scrollToBottom(!0),e.$textarea.focus()},100)):e.$container.addClass("wp-live-chat-hidden")}),s(document).on("click",this.selectors.closeBtn,function(){e.$container.addClass("wp-live-chat-hidden")}),s(document).on("click",this.selectors.container+" .chat-widget",function(t){s(t.target).closest(".chat-messages, .chat-header").length||setTimeout(()=>e.$textarea.focus(),50)}),s(document).on("click",this.selectors.saveInfoBtn,function(){const t=e.$phoneInput.val().trim(),n=e.$nameInput.val().trim();t||n?(s(this).prop("disabled",!0).html('<span class="btn-icon">â³</span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...'),s.ajax({url:e.ajaxurl,type:"POST",data:{action:"save_user_info",nonce:e.nonce,session_id:e.sessionId,phone:t,name:n,company:""},dataType:"json",timeout:1e4}).done(function(i){i&&i.success?(e.currentUser.phone=t||e.currentUser.phone,e.currentUser.name=n||e.currentUser.name,e.showUserForms(),e.showInputArea(!0),e.showAlert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯","success",3e3),s.post(e.ajaxurl,{action:"send_welcome_message",nonce:e.nonce,session_id:e.sessionId,user_name:e.currentUser.name})):e.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª","error",4e3)}).fail(function(){e.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±","error",4e3)}).always(function(){s(this).prop("disabled",!1).html('<span class="btn-icon">âœ“</span> Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª')})):e.showAlert("Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ÛŒØ§ Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯","error",3e3)}),s(document).on("click",this.selectors.skipInfoBtn,function(){e.currentUser=e.currentUser||{},e.currentUser.name=e.currentUser.name||"Ú©Ø§Ø±Ø¨Ø±_"+Math.floor(9e3*Math.random()+1e3),e.showUserForms(),e.showInputArea(!0),e.showAlert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¨Ø¹Ø¯Ø§Ù‹ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯","info",3e3)}),s(document).on("input",this.selectors.textarea,function(){e.updateCounter();const t=s(this).val().trim();!e.isTyping&&t.length>0?(e.isTyping=!0,e.sendTypingEvent("typing")):e.isTyping&&0===t.length&&(e.isTyping=!1,e.sendTypingEvent("stopped"))}),s(document).on("keyup",this.selectors.textarea,function(){clearTimeout(t),t=setTimeout(function(){e.isTyping&&(e.isTyping=!1,e.sendTypingEvent("stopped"))},1e3)}),s(document).on("click",this.selectors.sendBtn,function(){const s=e.$textarea.val().trim();e.sendMessage(s)}),s(document).on("keydown",this.selectors.textarea,function(t){if("Enter"===t.key&&!t.shiftKey){t.preventDefault();const n=s(this).val().trim();n&&!e.$sendBtn.prop("disabled")&&e.sendMessage(n)}}),s(document).on("animationend",this.selectors.inputArea,function(){s(this).is(":visible")&&e.$textarea.focus()})}showAlert(e,t="info",n=5e3){s(".alert-message").remove();const i={success:"âœ…",error:"âŒ",info:"â„¹ï¸",warning:"âš ï¸"},a=s(`\n        <div class="alert-message alert-${t}">\n          <span class="alert-icon">${i[t]||i.info}</span>\n          <div class="alert-content">\n            <div class="alert-title">${"success"===t?"Ù…ÙˆÙÙ‚ÛŒØª":"error"===t?"Ø®Ø·Ø§":"ØªÙˆØ¬Ù‡"}</div>\n            <div class="alert-text">${this._escapeHtml(e)}</div>\n          </div>\n          <button class="alert-close">&times;</button>\n        </div>\n      `);return s("body").append(a),a.find(".alert-close").on("click",function(){a.fadeOut(300,function(){s(this).remove()})}),n>0&&setTimeout(function(){a.is(":visible")&&a.fadeOut(300,function(){s(this).remove()})},n),a}setConnectedStatus(e){this.connected="online"===e;const s=this.$container.find(".status-dot"),t=this.$container.find(".status-text");s.removeClass("connecting online offline").addClass(e),t.text({online:"Ø¢Ù†Ù„Ø§ÛŒÙ†",offline:"Ø¢ÙÙ„Ø§ÛŒÙ†",connecting:"Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„..."}[e]||e)}updateCounter(){if(!this.$textarea||!this.$counter||!this.$sendBtn)return;const e=(this.$textarea.val()||"").length,s=this.maxChars-e;this.$counter.text(`${e}/${this.maxChars}`),0===e?(this.$sendBtn.prop("disabled",!0),this.$counter.removeClass("exceeded warning")):e>this.maxChars?(this.$sendBtn.prop("disabled",!0),this.$counter.addClass("exceeded")):(this.$sendBtn.prop("disabled",!1),this.$counter.removeClass("exceeded"),s<=50?this.$counter.addClass("warning"):this.$counter.removeClass("warning"))}updateNotificationBadge(e){this.unreadCount=e,this.$notif&&(!e||e<=0?this.$notif.hide():this.$notif.text(e>9?"9+":e).show())}scrollToBottom(e=!1,s=!1){if(!this.$messages||!this.$messages.length)return;const t=this.$messages[0].scrollHeight,n=this.$messages.height();!s&&t-(this.$messages.scrollTop()+n)>200||(e?this.$messages.scrollTop(t):this.$messages.stop().animate({scrollTop:t},300))}loadHistoryAndScroll(e=!1){const t=this;t.messageHistory.length>0&&!e?t.scrollToBottom(!0):(0===t.$messages.find(".message").length&&t.$messages.html(`\n        <div class="welcome-message">\n            <p>${t._escapeHtml(t.strings.welcome||"Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.")}</p>\n        </div>\n        <div class="loading-history" style="text-align:center; padding:20px; color:#666;">\n            <div class="spinner"></div>\n            <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡...</p>\n        </div>\n        `),s.ajax({url:t.ajaxurl,type:"POST",data:{action:"get_chat_history",nonce:t.nonce,session_id:t.sessionId},dataType:"json",timeout:1e4}).done(function(s){if(t.$messages.find(".loading-history").remove(),s&&s.success&&Array.isArray(s.data))if(s.data.length>0&&e&&(t.$messages.find(".welcome-message").remove(),t.$messages.find(".message").remove(),t.messageQueue.clear(),t.messageHistory=[]),0===s.data.length)setTimeout(()=>t.scrollToBottom(!0),100);else{let e=0;s.data.forEach(function(s){t.messageQueue.has(s.id)||(t.appendMessage({id:s.id,message:s.message_content,user_name:s.user_name,timestamp:s.created_at,type:s.message_type}),t.messageHistory.push({id:s.id,text:s.message_content,timestamp:s.created_at}),e++)}),e>0?setTimeout(()=>t.scrollToBottom(!0),200):t.scrollToBottom(!0)}else t.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡","error"),setTimeout(()=>t.scrollToBottom(!0),100)}).fail(function(){t.$messages.find(".loading-history").remove(),t.showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡","error"),setTimeout(()=>t.scrollToBottom(!0),100)}))}_formatTime(e){if(!e)return"";try{let s;if(s="string"==typeof e?e.includes("T")?new Date(e):new Date(e.replace(" ","T")):new Date(e),!isNaN(s.getTime()))return s.toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit",hour12:!1})}catch(e){}return e}_addEmojis(e){const s={":)":"ğŸ˜Š",":-)":"ğŸ˜Š",":(":"ğŸ˜",":-(":"ğŸ˜",":D":"ğŸ˜ƒ",":-D":"ğŸ˜ƒ",";)":"ğŸ˜‰",";-)":"ğŸ˜‰",":P":"ğŸ˜›",":-P":"ğŸ˜›",":O":"ğŸ˜®",":-O":"ğŸ˜®",":*":"ğŸ˜˜",":-*":"ğŸ˜˜","<3":"â¤ï¸",":heart:":"â¤ï¸",":like:":"ğŸ‘",":thumbsup:":"ğŸ‘",":thanks:":"ğŸ™",":ok:":"ğŸ‘Œ","?:":"â“"};let t=e;for(const[e,n]of Object.entries(s))t=t.replace(new RegExp(this._escapeRegex(e),"g"),n);return t}_escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}_escapeHtml(e){return s("<div/>").text(e||"").html()}_escapeAttr(e){return String(e||"").replace(/["'<>]/g,"")}_uuid(){return"xxxxxxxx".replace(/[x]/g,function(){return(16*Math.random()|0).toString(16)})}}s(function(){try{const n=new t(e.wpLiveChat||{});e._wpLiveChatFrontend=n,s("<style>").text("\n          .loading-history .spinner {\n            display: inline-block;\n            width: 40px;\n            height: 40px;\n            border: 3px solid #f3f3f3;\n            border-top: 3px solid #007cba;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n          }\n          @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n          }\n          .message-error {\n            opacity: 0.7;\n            border-color: #dc3232 !important;\n          }\n        ").appendTo("head")}catch(e){console.error("WPLiveChatFrontend init error",e)}})}}else console&&console.error&&console.error("jQuery required by WPLiveChatFrontend")}(window,jQuery);